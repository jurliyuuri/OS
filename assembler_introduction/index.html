<!doctype html>
<html>
<head>
<title>2003lk入門</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="../common.css">
<style>
.ny_jurli{
	background-color: #ffeeee;
	font-size:90%;
	padding: 0 10px;
}
</style>
<script>
function hide_ny_jurli()
{
	var elems = document.getElementsByClassName("ny_jurli");
	for(var i=0;i<elems.length;i++){
		elems[i].style.display = "none";
	}
}
</script>
</head>
<body class="cool">
<h1>2003lk入門</h1>
<p>ようこそ！ここでは2003lkの解説をしていきます。2003lkを学ぶと、連邦情報処理研究所が開発している計算機、2003'd ferlesyl (2003f) に様々な計算を正確に・高速にさせることができるようになります。[プログラミング](lerlo)の前提知識は要求しないような書き方になっているはずなので、よろしくお願いします。</p>
<div class="ny_jurli">
	<p>ここの部分のように、背景色が赤くなっている部分は、真理設定でないことを意味します。基本的にこの文書（理語バージョン）はファイクレオネでもそのまま通るような、真理設定にできるだけ近くなるような書き方をしていきますが、一部（実行環境のインストール方法など）どうしても非真理設定になるものがあるので、このような対応を取ります。→<input type="button" value="非真理設定を隠す" onclick="hide_ny_jurli()">をクリックすると非真理設定が非表示になります。ページを再読み込みすると戻ります。</p>
<hr>
<h2>現世にまつわる諸情報</h2>
<h3>2003lkを現世で使う方法</h3>
<ul>
	<li><a href="https://github.com/jurliyuuri/OS/tree/master/assembler">Haskell版インタプリタ</a>：j.vが作っている最新版。インストール方法の説明を書けていないので、分からなかったら<a href="https://twitter.com/sosoBOTpi">作者</a>に質問するか自力でなんとかするか、↓のWeb版を使うかしてください</li>
	<li><a href="http://na2co3.exp.jp/2003f-editor/">Web版インタプリタ（リンク切れてたので直した）</a>：Web上で実行できる。ファイル分割や乗算など一部の機能は未実装。</li>
</ul>
<h3>リンク集</h3>
<ul>
	<li>雑記・考察ログ：<a href="../opcode.html">「オペコードなどについて考察する」</a></li>
	<li>アセンブリ言語だけの最新の仕様：<a href="../settings.html">設定一覧</a></li>
	<li>専門用語の一覧：<a href="https://sites.google.com/site/panqateel/yougo">用語集</a></li>
	<li>Twitterで出た質問：Togetter（<a href="https://togetter.com/li/1151279">part1</a>, <a href="https://togetter.com/li/1153844">part2</a>, <a href="https://togetter.com/li/1156125">part3</a>）</li>
	<li>ソースコードの例：<a href="../fib_non_recursive.jurli.html">非再帰フィボナッチ</a>と<a href="../fib_recursive.jurli.html">再帰フィボナッチ</a>と<a href="../qsort.jurli.html">quicksort</a>と<a href="../lakormeru.jurli.html">開平</a></li>
</ul>
</div>
<hr>
<h2>ksi.1 2003'd ferlesylを知る</h2>
<p>2003lkは、[2003fの言語](2003f'd lkurftless)という名の通り、2003fを動かすために作られた言語です。ということで、まずは2003fを知ることから始めましょう。</p>
<h3>lexn.1 数の表現</h3>
<p>2003fは計算を行う装置なのですから、当然数を扱うことができます。2003fがどのようにして数を扱うかについて説明していきます。</p>
<p class="ny_jurli">現世の用語に詳しい人のための1行解説：32bit整数、負数は2の補数表現</p>
<p>[スイッチ](lysol)が32個横一列に並んでいる様子を想像してください。それぞれのボタンにあるのは押されているか押されていないかの2択ですが、これが32個集まると[2の32乗](2-inie-32)、つまり4294967296通りの状態を表すことができます。</p>
<p>さて、879というように数を書いたとき、7の位置には9の位置の10倍の価値があり、8の位置には7の10倍の価値があります。故に、879は（8と7と9を足し合わせたものでなく）[八百](xanlekqa)と[七十](anxenqa)と[九](fentiqa)を合わせたものになるのです。</p>
<p>これを先ほどのスイッチ列に応用することができます。右端のスイッチの価値を1、その左を2、そのさらに左を4、というふうに決めていくと、32個のスイッチで0から4294967295までの数を扱うことができます。</p>
<p>では、負の数を扱う時にはどうすればいいでしょうか。実は、左端のスイッチの価値を2147483648ではなく-2147483648と解釈してあげると、-2147483648から2147483647までの数を扱うことができるようになるのです。</p>
<p>これは、4294967296を周期として整数を同一視することと同じです。例えば、-12と（それに4294967296を足した）4294967284
を同一視し、17と（それに4294967296を足した）4294967313を同一視することで、どちらで解釈したとしても、足し算・引き算は同じ挙動で動作できることが分かります。</p>
<pre style="font-size:120%">
  11111111111111111111111111110100 → -12
<u>+ 00000000000000000000000000011101 →  29</u>
 <span style="color:#999">1</span>00000000000000000000000000010001 →  17 

  11111111111111111111111111110100 → 4294967284
<u>+ 00000000000000000000000000011101 →         29</u>
 <span style="color:#999">1</span>00000000000000000000000000010001 → 4294967313
</pre>
<p>ここで、一番左に書いてある灰色の1は便宜上のもので、実際にはありません。</p>
<h3>lexn.2 記憶装置</h3>
<p>計算をするには数を記憶しなければいけません。2003fには、目的に応じて2種類の記憶装置があります。</p>
<ul>
	<li>[メモ](firjal)：個数が僅かしかないが、素早く読み書きできる<span class="ny_jurli">レジスタのこと。</span></li>
	<li>[住所箱](setistafar)：多量のデータを保存できるが、読み書きが遅い<span class="ny_jurli">メモリのこと。</span></li>
</ul>
<p>firjalはいくつかありますが、その中でも今回使っていくのは6種類。それぞれに<code>f0</code>, <code>f1</code>, <code>f2</code>, <code>f3</code>, <code>f5</code>, <code>xx</code>という名前が付いています。それぞれのfirjalに、先ほど述べた32個のスイッチ列が入っています。</p>
<p>なお、fはfirjalの略です。<code>xx</code>はxeumon xelal（「次に見るところ」）の略称ですが、詳しいことは後述します。</p>
<p>setistafarは、[住所](sietival)と[箱](stafiort)という語からなっていることからも分かるように、住所のようなものを指定することで、その場所に数を記録することができます。ただし、住所といっても普通の住所とは違ってこれまた数で表すので、[住所](<strong>sie</strong>tival)ではなく[アドレス](<strong>se</strong>tival)と呼びます。</p>
<p>setivalは0から4294967292までの数で、必ず4で割り切れます。それぞれのsetivalのところにはこれまた32個のスイッチ列があって、そこに数を記録できます。</p>
<p>[メモ](firjal)はその名前の通り一時的なメモに過ぎないので、計算の過程でどんどん上書きしていって構いません。特に、<code>f0</code>, <code>f1</code>, <code>f2</code>, <code>f3</code>は計算をするときに使うべき[メモ](firjal)です。一方、[住所箱](setistafar)に入れている情報は末永く使う可能性があり、またそもそも読み書きが遅いので、一時的な値を入れたりするのはよくありません。</p>
<h3>lexn.3 命令</h3>
<p>2003fは[命令](xlaiso)を与えられることによって動作します。その命令を記述するための言語が2003lkです。</p>
<h3>lexn.4 基本動作</h3>
<p>2003fは、命令を見ながら基本的にはそれを順次実行していきます。それを実現するために、2003fは<code>nx</code>（[今見ているところ](noon xelal)の略）と<code>xx</code>（[xeumon xelal](次に見るところ) の略）という2つのfirjalを持っています。なお、<code>nx</code>というfirjalは隠されており、我々は直接<code>nx</code>というfirjalに働きかけることはできません。</p>
<p>2003fの基本動作は単純で、以下の3つの動作をひたすら繰り返します。</p>
<ol>
	<li>xxが次の命令を指すようにする</li>
	<li>nxの指す命令を実行する</li>
	<li>xxの指す命令をnxも指すようにする</li>
</ol>
<p>これを繰り返していくことで、命令を次々に実行していけることが分かるかと思います。</p>
<p>このような単純な動作だけで複雑な作業を行わせるにはどうすればいいのでしょう？それについて、これから見ていくことにしましょう。</p>

<hr>
<h2>ksi.2 基礎的な命令</h2>

<h3>lexn.1 <code>kRz</code>命令</h3>
<p>最もよく使う命令として、<code>kRz</code>命令があります。これは値を[書き写す](kRantairzarth)命令で、[メモ](firjal)や[住所箱](setistafar)の間で値を書き写す作業を行うことができます。</p>

<p>例えば、<code>kRz f0 f1</code>と書くと、<code>f0</code>[を](-'i)読んで<code>f1</code>[に](-'c)書き写せ、という命令になります。この際、<code>f1</code>は<strong>完全に上書き</strong>され、元の<code>f1</code>の値は失われます。先頭に動詞、次に「[を](-'i)」、最後に「[に](-'c)」を置くのが基本的な書き方です。<span class="ny_jurli">AT&T Syntaxですな</span></p>

<p>（なお、先に「[に](-'c)」が来てその後に「[を](-'i)」が来る言語を話している人のために、先頭に<code>'c'i</code>と書くことでそれ以降の部分を全て「[に](-'c)の後に[を](-'i)」の語順として扱わせることができます。<span class="ny_jurli">Intel Syntaxに慣れているみなさんも一安心</span>もとに戻す場合は<code>'i'c</code>と書きます。混乱を避けるため、この解説では一貫して<code>'c'i</code>の使用を控えます。）</p>

<p>例として、<code>f0</code>の値を<code>f1</code>に複製した後、<code>f1</code>の値を<code>f2</code>に複製する命令列は以下のようになります。</p>

<div class="box">
<pre>
	kRz f0 f1
	kRz f1 f2
</pre>
</div>

<p>これを実行すると、もともと<code>f0</code>に入っていた値が<code>f1</code>にも<code>f2</code>にも入ります。</p>
<p>順番を逆にして、</p>


<div class="box">
<pre>
	kRz f1 f2
	kRz f0 f1
</pre>
</div>

<p>とするとどうなるでしょうか？この場合は先ほどと違い、3つの[メモ](firjal)が全て同じ値になるとは限りません。もともと<code>f1</code>に入っていた値は<code>f2</code>に移り、<code>f1</code>は新しく<code>f0</code>の値で<strong>上書きされ</strong>ます。</p>

<p>また、特定の数値を直接[メモ](firjal)に入れることもできます。</p>

<div class="box">
<pre>
	kRz  3 f1
	kRz f1 f2
</pre>
</div>

<p>とすると、まず数値3が<code>f1</code>に入り、次にそれが<code>f2</code>に書き写されます。</p>

<p>もちろん、次のような操作を行うことはできません。</p>

<div class="error_box">
<pre>
	kRz f1 2
</pre>
</div>

<p>数値「2」は当然記憶装置ではないので、そこに対して値を書き込むことなどできるはずがないからです。</p>

<p>さて、これで[メモ](firjal)を操作することができるようになりましたが、[住所箱](setistafar)を操作したいときにはどうすればよいのでしょうか？次はそれを見ていきましょう。</p>


<h3>lexn.2 [住所箱](setistafar)の操作</h3>

<p>個数が少なく直接名前で指定できる[メモ](firjal)と異なり、[住所箱](setistafar)の操作には、名前通り[アドレス](setival)を使います。例えば、3529356308という場所に住んでいる[住所箱](setistafar)から値を取ってきて<code>f1</code>に複製するには、次のように書きます。</p>

<div class="box">
<pre>
	kRz 3529356308 f0
	kRz        f0@ f1
</pre>
</div>

<p><code>@</code>が[〜という場所で](io)の略字であることは皆さんご存知かと思われますが、<span class="ny_jurli">注：リパーシェのiとoをくっつけた合字があり、それのASCII代替表示として<code>@</code>を用いる。詳しくは<a href="https://drive.google.com/file/d/1RwtPFMu7-ckelB2WKbdxYQGTAZ8xxQAb/view">「初学者のためのリパライン語」</a>を参照すること。</span>まさに<code>f0</code>という[メモ](firjal)に書いている住所[〜という場所で](io)情報を読んでくる、という意味になるのです。</p>

<p>ここでは3529356308という場所を見に行くために一時的に<code>f0</code>を使っていますが、なぜ</p>

<div class="error_box">
<pre>
	kRz 3529356308@ f1
</pre>
</div>

<p>とは書かないのでしょう？</p>

<p>実は、住所を指定する際に直接数値を書いて場所を指定することは意外に少なく、住所は[メモ](firjal)に書いていることが圧倒的に多いのです。ですから、2003lkでは数値に<code>@</code>を付けるという機能そのものを搭載していないのです。</p>

<p>ちなみに、</p>

<div class="box">
<pre>
	kRz f0 f0
</pre>
</div>

<p>や</p>

<div class="box">
<pre>
	kRz f1@ f1@
</pre>
</div>

<p>のように、書き写し元と書き写し先が同一のものを指している場合は、何も起きません。この「何も起きない」ということを明示的に表すために、<code>kRz f0 f0</code>の別名として、[何もしない](fav es niv e'i)を略した<code>fen</code>という名前を使うことができます。</p>

<p class="ny_jurli">to do: 間接参照、思っていた以上に混乱を招いたのでもうちょい書くべし</p>

<h3>lexn.3 足し算・引き算</h3>

<p>値を複製する方法は分かりましたが、複製だけやっていてもあまり面白くありません。2003fは計算機なのですから、計算をしてもらわなくてはいけないでしょう。まずは足し算と引き算を行う方法を見ていきましょう。</p>

<p><code>f0</code>を13だけ増やす、つまり、<code>13</code>という数値 [を](-'i) <code>f0</code> [に](-'c) [足す](atakeses)には、次のように書きます。</p>

<div class="box">
<pre>
	ata 13 f0
</pre>
</div>


<p><code>f0</code>を37だけ減らす、つまり、<code>37</code>という数値 [を](-'i) <code>f0</code> [から](-'c) [減じる](ny atakeses)には、次のように書きます。</p>

<p>このとき<code>f0</code>にはどんな値が入っているでしょうか？分かりません。もともとの値に比べて13だけ増えていることは確実ですが、[メモ](firjal)にどんな値が入っていたのかが全く分からないので分かりません。これに限らず、明示的に値を設定していない[メモ](firjal)にはどんな値が入っているのかは一般に分かりません。<span class="ny_jurli">現世流に言うなら「未初期化のレジスタにはゴミが入っている」</span></p>


<div class="box">
<pre>
	nta 37 f0
</pre>
</div>

<p>もちろん、[メモ](firjal)の値を[住所箱](setistafar)に足し合わせることもできます。</p>

<div class="box">
<pre>
	ata f0 f1@
</pre>
</div>

<p><code>ata 13 f0</code>で13が変更されたりしないのと同じように、この命令で<code>f0</code>の値が変化することはありません。</p>

<p>なお、当然のことですが、数値を変更するような操作は許されません。</p>

<div class="error_box">
<pre>
	ata f2 3
</pre>
</div>

<p>練習として、住所4242149312にある値と、住所3274190944にある値を読み、それらの和を住所674147896に出力するようなプログラムを書くことを考えてみましょう。↓のように書けば正しく動くでしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
ata f0 f1@
kRz f1@ 674147896
</pre>
</div>

<p>いいえ、これでは上手くいきません。まず、3行目で<code>ata f0 f1@</code>とありますが、これでは増分は<code>f0</code>の値、つまり<code>4242149312</code>という数になってしまい、<code>4242149312</code>という住所にある値ではないからです。</p>
<p>では、こう直せばいいのでしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
ata f0@ f1@
kRz f1@ 674147896
</pre>
</div>

<p>いいえ、まだダメです。どこが間違っているか分かりますか？</p>
<p>そう、これでは「数値を変更する」ような命令になってしまいますので、これまた正しく動きません。では、こうすればよいのでしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
ata f0@ f1@
kRz 674147896 f2
kRz f1@ f2@
</pre>
</div>

<p>これはかなり惜しいところまで行っています。これは先程までの誤ったプログラムと違って、ちゃんと動いてくれます。ただし、思っていたのとは微妙に違う挙動になってしまうのです。さて、何が問題なのでしょう？</p>
<p>問題は、この操作の過程で<code>f1@</code>の値が変更されてしまうことです。結果の出力先は住所674147896であって、住所3274190944の値をこっそり変更してしまっては困ります。</p>
<p>では、こう直せば今度こそ大丈夫でしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
kRz 674147896 f2
kRz f1@ f3
kRz f0@ f2@
ata f3@ f2@
</pre>
</div>

<p>とても惜しい。誤植があります。<code>kRz</code>したのは<code>f3</code>ですが<code>ata</code>しているのは<code>f3@</code>ですね？</p>
<p>じゃあこうすればいいのでしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
kRz 674147896 f2
kRz f1@ f3@
kRz f0@ f2@
ata f3@ f2@
</pre>
</div>

<p>これは動きますが、マズいです。<code>f3@</code>はメモリ（しかもどの住所なのかよくわからないメモリ）で、そこを破壊してしまっているからです。</p>
<p>一時的な保管場所として使いたいのは<code>f3@</code>ではなく<code>f3</code>ですから、こうなります。</p>


<div class="box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
kRz 674147896 f2
kRz f1@ f3
kRz f0@ f2@
ata f3 f2@
</pre>
</div>

<p>これでやっと正しく動いてくれます。ふぅ。</p>

<p>なお、別解としては、次のような書き方もあります。</p>

<div class="box">
<pre>
kRz 674147896 f2
kRz 0 f2@
kRz 4242149312 f0
ata f0@ f2@
kRz 3274190944 f1
ata f1@ f2@
</pre>
</div>

<p>この方法は、書き換えてやることでレジスタを節約できるという利点もあります。</p>

<div class="box">
<pre>
kRz 674147896 f0
kRz 0 f0@
kRz 4242149312 f1
ata f1@ f0@
kRz 3274190944 f1
ata f1@ f0@
</pre>
</div>

<p>他にも、多少強引ですが「足してしまった分を引けば良い」という考えでこうしてやることもできます。</p>

<div class="box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
kRz 674147896 f2
ata f0@ f1@
kRz f1@ f2@
nta f0@ f1@
</pre>
</div>

<h3>lexn.4 <code>kRz</code>命令の別用途</h3>

<p>ここまで、<code>kRz</code>・<code>ata</code>・<code>nta</code>と3種類の命令を学んできましたが、この3つの命令では今のところ数を複製したり足したりすることしかできません。また、足し算を何千回も繰り返すには、足し算命令を何千回を書くしかなさそうです。</p>
<p>…本当にそうでしょうか？なにか見落としはないでしょうか？もう一度2003fの基本動作を見ていきましょう。</p>

<ol>
	<li>xxが次の命令を指すようにする</li>
	<li>nxの指す命令を実行する</li>
	<li>xxの指す命令をnxも指すようにする</li>
</ol>

<p>ここで、「2. nxの指す命令を実行する」ことによって<code>xx</code>の値を上書きしたらどうなるでしょうか？「3. xxの指す命令をnxも指すようにする」によりその値が<code>nx</code>に伝播し、次の「1.」で新<code>nx</code>の次を<code>xx</code>が指すようになります。そうして新<code>nx</code>の指す命令が実行されるので、結果としては「上書きされたxxの指す場所に飛んでいって実行することができる」ということになります。</p>

<p>しかし、「上書きされたxxの指す場所に飛んでいく」といっても、飛んでいくべき場所が具体的にどんな数値で表されるのでしょう？今の我々にはそれを知る手段がありません。そのために使うのが <code>nll</code> というものです。</p>

<p><code>nll</code>は「[次に述べるもの](ny la lex)」の略で、直後に名前を書き、その後に命令を書くことで、その命令に名前を付けることができます。</p>

<p>つまり、</p>

<div class="box">
<pre>
kRz 3 f2 
nll panqa
ata f3 f2
kRz f0 f3@
</pre>
</div>

<p>と書くことで、<code>ata f3 f2</code>に対して<code>panqa</code>という名前を付けることができます。</p>

<p>名前を付けた場所に飛んでいくためには、その名前を直接<code>xx</code>に<code>kRz</code>することで実現できます。</p>

<div class="box">
<pre>
kRz 3 f2
kRz panqa xx
kRz 5 f2
nll panqa
fen
</pre>
</div>

<p>とすると、最後までたどり着いたときの<code>f2</code>の値は5ではなく3になります。</p>


<hr>
<footer style="text-align:right"><p>phil.2005年2月</p><p class="ny_jurli">…に執筆されたという設定。現世でこの文章を書いているのは西暦2017年の10月…からずっと放置して2018年の8月。</p><p class="ny_jurli">どうしようかな、ubpl開発以降の文章という設定にしてもいいんだけど。そっちの方が面白いかもな。</p></footer>


</body>
