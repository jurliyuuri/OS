<!doctype html>
<html>
<head>
<title>2003lk入門</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="../common.css">
<style>
.ny_jurli{
	background-color: #ffeeee;
	font-size:90%;
	padding: 0 10px;
}
</style>
<script>
function hide_ny_jurli()
{
	var elems = document.getElementsByClassName("ny_jurli");
	for(var i=0;i<elems.length;i++){
		elems[i].style.display = "none";
	}
}
</script>
</head>
<body class="cool">
<h1>2003lk入門</h1>
<p>ようこそ！ここでは2003lkの解説をしていきます。2003lkを学ぶと、連邦情報処理研究所が開発している計算機、2003'd ferlesyl (2003f) に様々な計算を正確に・高速にさせることができるようになります。[プログラミング](lerlo)の前提知識は要求しないような書き方になっているはずなので、よろしくお願いします。</p>
<div class="ny_jurli">
	<p>ここの部分のように、背景色が赤くなっている部分は、真理設定でないことを意味します。基本的にこの文書（理語バージョン）はファイクレオネでもそのまま通るような、真理設定にできるだけ近くなるような書き方をしていきますが、一部（実行環境のインストール方法など）どうしても非真理設定になるものがあるので、このような対応を取ります。→<input type="button" value="非真理設定を隠す" onclick="hide_ny_jurli()">をクリックすると非真理設定が非表示になります。ページを再読み込みすると戻ります。</p>
<hr>
<h2>現世にまつわる諸情報</h2>
<h3>2003lkを現世で使う方法</h3>
<ul>
	<li><a href="https://github.com/jurliyuuri/OS/tree/master/assembler">Haskell版インタプリタ</a>：j.vが作っている最新版。インストール方法の説明を書けていないので、分からなかったら<a href="https://twitter.com/sosoBOTpi">作者</a>に質問するか自力でなんとかするか、↓のWeb版を使うかしてください</li>
	<li><a href="http://na2co3.exp.jp/2003f-editor/">Web版インタプリタ（リンク切れてたので直した）</a>：Web上で実行できる。ファイル分割や乗算など一部の機能は未実装。</li>
</ul>
<h3>リンク集</h3>
<ul>
	<li>雑記・考察ログ：<a href="../opcode.html">「オペコードなどについて考察する」</a></li>
	<li>アセンブリ言語だけの最新の仕様：<a href="../settings.html">設定一覧</a></li>
	<li>専門用語の一覧：<a href="https://sites.google.com/site/panqateel/yougo">用語集</a></li>
	<li>Twitterで出た質問：Togetter（<a href="https://togetter.com/li/1151279">part1</a>, <a href="https://togetter.com/li/1153844">part2</a>, <a href="https://togetter.com/li/1156125">part3</a>）</li>
	<li>ソースコードの例：<a href="../fib_non_recursive.jurli.html">非再帰フィボナッチ</a>と<a href="../fib_recursive.jurli.html">再帰フィボナッチ</a>と<a href="../qsort.jurli.html">quicksort</a>と<a href="../lakormeru.jurli.html">開平</a></li>
</ul>
</div>
<hr>
<h2>ksi.1 2003'd ferlesylを知る</h2>
<p>2003lkは、[2003fの言語](2003f'd lkurftless)という名の通り、2003fを動かすために作られた言語です。ということで、まずは2003fを知ることから始めましょう。</p>
<h3>lexn.1 数の表現</h3>
<p>2003fは計算を行う装置なのですから、当然数を扱うことができます。2003fがどのようにして数を扱うかについて説明していきます。</p>
<p class="ny_jurli">現世の用語に詳しい人のための1行解説：32bit整数、負数は2の補数表現</p>
<p>[スイッチ](lysol)が32個横一列に並んでいる様子を想像してください。それぞれのボタンにあるのは押されているか押されていないかの2択ですが、これが32個集まると[2の32乗](2-inie-32)、つまり4294967296通りの状態を表すことができます。</p>
<p>さて、879というように数を書いたとき、7の位置には9の位置の10倍の価値があり、8の位置には7の10倍の価値があります。故に、879は（8と7と9を足し合わせたものでなく）[八百](xanlekqa)と[七十](anxenqa)と[九](fentiqa)を合わせたものになるのです。</p>
<p>これを先ほどのスイッチ列に応用することができます。右端のスイッチの価値を1、その左を2、そのさらに左を4、というふうに決めていくと、32個のスイッチで0から4294967295までの数を扱うことができます。</p>
<p>では、負の数を扱う時にはどうすればいいでしょうか。実は、左端のスイッチの価値を2147483648ではなく-2147483648と解釈してあげると、-2147483648から2147483647までの数を扱うことができるようになるのです。</p>
<p>これは、4294967296を周期として整数を同一視することと同じです。例えば、-12と（それに4294967296を足した）4294967284
を同一視し、17と（それに4294967296を足した）4294967313を同一視することで、どちらで解釈したとしても、足し算・引き算は同じ挙動で動作できることが分かります。</p>
<pre style="font-size:120%">
  11111111111111111111111111110100 → -12
<u>+ 00000000000000000000000000011101 →  29</u>
 <span style="color:#999">1</span>00000000000000000000000000010001 →  17 

  11111111111111111111111111110100 → 4294967284
<u>+ 00000000000000000000000000011101 →         29</u>
 <span style="color:#999">1</span>00000000000000000000000000010001 → 4294967313
</pre>
<p>ここで、一番左に書いてある灰色の1は便宜上のもので、実際にはありません。</p>
<h3>lexn.2 記憶装置</h3>
<p>計算をするには数を記憶しなければいけません。2003fには、目的に応じて2種類の記憶装置があります。</p>
<ul>
	<li>[メモ](firjal)：個数が僅かしかないが、素早く読み書きできる<span class="ny_jurli">レジスタのこと。</span></li>
	<li>[住所箱](setistafar)：多量のデータを保存できるが、読み書きが遅い<span class="ny_jurli">メモリのこと。</span></li>
</ul>
<p>firjalはいくつかありますが、その中でも今回使っていくのは6種類。それぞれに<code>f0</code>, <code>f1</code>, <code>f2</code>, <code>f3</code>, <code>f5</code>, <code>xx</code>という名前が付いています。それぞれのfirjalに、先ほど述べた32個のスイッチ列が入っています。</p>
<div class="machine_state_box">
<table class="memory">
<tr>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
</tr>
<tr>
	<td class="k">f0</td>
	<td class="k">f1</td>
	<td class="k">f2</td>
	<td class="k">f3</td>
	<td class="k">f5</td>
	<td class="k">xx</td>
</tr>
</table>
</div>
<p>なお、fはfirjalの略です。<code>xx</code>はxeumon xelal（「次に見るところ」）の略称ですが、詳しいことは後述します。</p>
<p>setistafarは、[住所](sietival)と[箱](stafiort)という語からなっていることからも分かるように、住所のようなものを指定することで、その場所に数を記録することができます。ただし、住所といっても普通の住所とは違ってこれまた数で表すので、[住所](<strong>sie</strong>tival)ではなく[アドレス](<strong>se</strong>tival)と呼びます。</p>
<p>setivalは0から4294967292までの数で、必ず4で割り切れます。それぞれのsetivalのところにはこれまた32個のスイッチ列があって、そこに数を記録できます。</p>

<div class="machine_state_box">
<table class="memory">
<tr>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
	<td>スイッチ列</td>
</tr>
<tr>
	<td class="k">39460番地</td>
	<td class="k">39464番地</td>
	<td class="k">39468番地</td>
	<td class="k">39472番地</td>
	<td class="k">39476番地</td>
	<td class="k">39480番地</td>
	<td class="k">39488番地</td>
</tr>
</table>
</div>

<p>[メモ](firjal)はその名前の通り一時的なメモに過ぎないので、計算の過程でどんどん上書きしていって構いません。特に、<code>f0</code>, <code>f1</code>, <code>f2</code>, <code>f3</code>は計算をするときに使うべき[メモ](firjal)です。一方、[住所箱](setistafar)に入れている情報は末永く使う可能性があり、またそもそも読み書きが遅いので、一時的な値を入れたりするのはよくありません。</p>
<h3>lexn.3 命令</h3>
<p>2003fは[命令](xlaiso)を与えられることによって動作します。その命令を記述するための言語が2003lkです。</p>
<h3>lexn.4 基本動作</h3>
<p>2003fは、命令を見ながら基本的にはそれを順次実行していきます。それを実現するために、2003fは<code>nx</code>（[今見ているところ](noon xelal)の略）と<code>xx</code>（[xeumon xelal](次に見るところ) の略）という2つのfirjalを持っています。なお、<code>nx</code>というfirjalは隠されており、我々は直接<code>nx</code>というfirjalに働きかけることはできません。</p>
<p>2003fの基本動作は単純で、以下の3つの動作をひたすら繰り返します。</p>
<ol>
	<li>xxが次の命令を指すようにする</li>
	<li>nxの指す命令を実行する</li>
	<li>xxの指す命令をnxも指すようにする</li>
</ol>
<p>これを繰り返していくことで、命令を次々に実行していけることが分かるかと思います。</p>
<p>このような単純な動作だけで複雑な作業を行わせるにはどうすればいいのでしょう？それについて、これから見ていくことにしましょう。</p>

<hr>
<h2>ksi.2 基礎的な命令</h2>
<h3>lexn.0 本資料での表記法</h3>

<div class="box">
<pre>
	kRz  3 f1
	kRz f1 f2
</pre>
</div>

<p>↑この枠は、書かれているのが正しい記述であることを意味します。</p>


<div class="error_box">
<pre>
	kRz f1 2
</pre>
</div>

<p>↑この枠は、書かれているのが2003lkの文法に反していることを意味します。</p>


<div class="dubious_box">
<pre>
	kRz f1 f0@
</pre>
</div>

<p>↑この枠は、記述が2003lkの文法に反しているわけではないが、誤った動作・危険な動作・意図しない動作をしかねないことを意味します。</p>

<div class="machine_state_box">
<table class="memory">
<tr>
	<td>969781</td>
	<td>1691140026</td>
	<td>2296088114</td>
	<td>855978409</td>
	<td>2141598056</td>
	<td>3574815992</td>
</tr>
<tr>
	<td class="k">f0</td>
	<td class="k">f1</td>
	<td class="k">f2</td>
	<td class="k">f3</td>
	<td class="k">f5</td>
	<td class="k">xx</td>
</tr>
</table>
</div>

<p>↑この枠は、2003lkで操作している最中の2003fの状態を表します。</p>

<h3>lexn.1 <code>kRz</code>命令</h3>
<p>最もよく使う命令として、<code>kRz</code>命令があります。これは値を[書き写す](kRantairzarth)命令で、[メモ](firjal)や[住所箱](setistafar)の間で値を書き写す作業を行うことができます。</p>

<p>例えば、<code>kRz f0 f1</code>と書くと、<code>f0</code>[を](-'i)読んで<code>f1</code>[に](-'c)書き写せ、という命令になります。この際、<code>f1</code>は<strong>完全に上書き</strong>され、元の<code>f1</code>の値は失われます。先頭に動詞、次に「[を](-'i)」、最後に「[に](-'c)」を置くのが基本的な書き方です。<span class="ny_jurli">AT&T Syntaxですな</span></p>

<p>（なお、先に「[に](-'c)」が来てその後に「[を](-'i)」が来る言語を話している人のために、先頭に<code>'c'i</code>と書くことでそれ以降の部分を全て「[に](-'c)の後に[を](-'i)」の語順として扱わせることができます。<span class="ny_jurli">Intel Syntaxに慣れているみなさんも一安心</span>もとに戻す場合は<code>'i'c</code>と書きます。混乱を避けるため、この解説では一貫して<code>'c'i</code>の使用を控えます。）</p>

<p>例として、<code>f0</code>の値を<code>f1</code>に複製した後、<code>f1</code>の値を<code>f2</code>に複製する命令列は以下のようになります。</p>

<div class="box">
<pre>
	kRz f0 f1
	kRz f1 f2
</pre>
</div>

<p>これを実行すると、もともと<code>f0</code>に入っていた値が<code>f1</code>にも<code>f2</code>にも入ります。</p>

<p>なお、「もともと<code>f0</code>に入っていた値」とは具体的にどんな値なのでしょう？分かりません。これに限らず、明示的に値を設定していない[メモ](firjal)にはどんな値が入っているのかは一般に分かりません。<span class="ny_jurli">現世流に言うなら「未初期化のレジスタにはゴミが入っている」</span></p>

<p>順番を逆にして、</p>


<div class="box">
<pre>
	kRz f1 f2
	kRz f0 f1
</pre>
</div>

<p>とするとどうなるでしょうか？この場合は先ほどと違い、3つの[メモ](firjal)が全て同じ値になるとは限りません。もともと<code>f1</code>に入っていた値は<code>f2</code>に移り、<code>f1</code>は新しく<code>f0</code>の値で<strong>上書きされ</strong>ます。</p>

<p>また、特定の数値を直接[メモ](firjal)に入れることもできます。</p>

<div class="box">
<pre>
	kRz  3 f1
	kRz f1 f2
</pre>
</div>

<p>とすると、まず数値3が<code>f1</code>に入り、次にそれが<code>f2</code>に書き写されます。</p>

<p>もちろん、次のような操作を行うことはできません。</p>

<div class="error_box">
<pre>
	kRz f1 2
</pre>
</div>

<p>数値「2」は当然記憶装置ではないので、そこに対して値を書き込むことなどできるはずがないからです。</p>


<p>ちなみに、</p>

<div class="box">
<pre>
	kRz f0 f0
</pre>
</div>

<p>のように、書き写し元と書き写し先が同一の[メモ](firjal)を指している場合は、何も起きません。この「何も起きない」ということを明示的に表すために、<code>kRz f0 f0</code>の別名として、[何もしない](fav es niv e'i)を略した<code>fen</code>という名前を使うことができます。</p>


<p class="ny_jurli">メモリに関しては、<code>kRz f1@ f1@</code>
で何も起きない保証はない（メモリが読み取り専用だったり存在しなかったりしたら例外になるでしょう）が、そもそも例外機構自体の仕様が定まっていないし言及しないのが吉</p>

<p>さて、これで[メモ](firjal)を操作することができるようになりましたが、[住所箱](setistafar)を操作したいときにはどうすればよいのでしょうか？次はそれを見ていきましょう。</p>


<h3>lexn.2 [住所箱](setistafar)の操作</h3>

<p>個数が少なく直接名前で指定できる[メモ](firjal)と異なり、[住所箱](setistafar)の操作には、名前通り[アドレス](setival)を使います。例えば、3529356308という場所に住んでいる[住所箱](setistafar)から値を取ってきて<code>f1</code>に複製するには、次のように書きます。</p>

<div class="box">
<pre>
	kRz 3529356308 f0
	kRz        f0@ f1
</pre>
</div>

<p><code>@</code>が[〜という場所で](io)の略字であることは皆さんご存知かと思われますが、<span class="ny_jurli">注：リパーシェのiとoをくっつけた合字があり、それのASCII代替表示として<code>@</code>を用いる。詳しくは<a href="https://drive.google.com/file/d/1RwtPFMu7-ckelB2WKbdxYQGTAZ8xxQAb/view">「初学者のためのリパライン語」</a>を参照すること。</span>まさに<code>f0</code>という[メモ](firjal)に書いている住所[〜という場所で](io)情報を読んでくる、という意味になるのです。</p>


<p>少し分かりにくい箇所なので、図で追いかけていきましょう。まず、最初の<code>kRz 3529356308 f0</code>の結果、firjalはこうなります。</p>
<div class="machine_state_box">
<table class="memory">
<tr>
	<td>3529356308</td>
	<td>?</td>
	<td>?</td>
	<td>?</td>
	<td>?</td>
	<td>?</td>
</tr>
<tr>
	<td class="k">f0</td>
	<td class="k">f1</td>
	<td class="k">f2</td>
	<td class="k">f3</td>
	<td class="k">f5</td>
	<td class="k">xx</td>
</tr>
</table>
</div>

<p>その次の<code>kRz        f0@ f1</code>では、<code>f0</code>という[メモ](firjal)に書いている住所[〜という場所で](io)情報を読んでくるので、住所箱が下のようになっているとき、</p>

<div class="machine_state_box">
<table class="memory">
<tr>
	<td>56593777</td>
	<td>3</td>
	<td>2718972307</td>
	<td>3157158970</td>
</tr>
<tr>
	<td class="k">3529356304番地</td>
	<td class="k">3529356308番地</td>
	<td class="k">3529356312番地</td>
	<td class="k">3529356316番地</td>
</tr>
</table>
</div>

<p>読んでくるべき値は3529356308番地に置いてある「3」です。これが<code>f1</code>に複製され、firjalは</p>

<div class="machine_state_box">
<table class="memory">
<tr>
	<td>3529356308</td>
	<td>3</td>
	<td>?</td>
	<td>?</td>
	<td>?</td>
	<td>?</td>
</tr>
<tr>
	<td class="k">f0</td>
	<td class="k">f1</td>
	<td class="k">f2</td>
	<td class="k">f3</td>
	<td class="k">f5</td>
	<td class="k">xx</td>
</tr>
</table>
</div>

<p>となるのです。</p>

<p><code>f0</code>と<code>f0@</code>で意味が<strong>大きく異なる</strong>ことに細心の注意を払ってください。<code>f0</code>は[メモ](firjal)ですが<code>f0@</code>は[住所箱](setistafar)です。<code>f0</code>を操作しているときは一時的な[メモ](firjal)の操作に過ぎませんが、<code>f0@</code>の操作は[住所箱](setistafar)の操作であって、一歩間違えれば[住所箱](setistafar)に保管されているデータを<strong>どんどん破壊していってしまうかもしれない</strong>ことを肝に銘じておきましょう。</p>

<p>さらに言えば、単独で次のように書いた場合、</p>

<div class="dubious_box">
<pre>
	kRz f1 f0@
</pre>
</div>

<p>これは<code>f1</code>の値を[住所箱](setistafar)のどこに書き込んでいるのでしょうか？もうお分かりですね、「<strong>分からない</strong>」のです。住所である<code>f0</code>に何が入っているのか<strong>完全に不明</strong>で、<strong>どこか得体の知れない場所</strong>に書き込んでいるのです。これはとても危険なので、<strong>決してやってはいけません</strong>。</p>

<p>ちなみに、先程の</p>

<div class="box">
<pre>
	kRz 3529356308 f0
	kRz        f0@ f1
</pre>
</div>

<p>では3529356308という場所を見に行くために一時的に<code>f0</code>を使っていますが、なぜ</p>

<div class="error_box">
<pre>
	kRz 3529356308@ f1
</pre>
</div>

<p>とは書かないのでしょう？</p>

<p>実は、今後実践していくとだんだん分かってくるように、住所を指定する際に直接数値を書いて場所を指定することは意外に少なく、住所は[メモ](firjal)に書いていることが圧倒的に多いのです。ですから、2003lkでは数値に<code>@</code>を付けるという機能そのものを搭載していないのです。</p>




<h3>lexn.3 足し算・引き算</h3>

<p>値を複製する方法は分かりましたが、複製だけやっていてもあまり面白くありません。2003fは計算機なのですから、計算をしてもらわなくてはいけないでしょう。まずは足し算と引き算を行う方法を見ていきましょう。</p>

<p><code>f0</code>を13だけ増やす、つまり、<code>13</code>という数値 [を](-'i) <code>f0</code> [に](-'c) [足す](atakeses)には、次のように書きます。</p>

<div class="box">
<pre>
	ata 13 f0
</pre>
</div>



<p>このとき<code>f0</code>にはどんな値が入っているでしょうか？そう、「分からない」のです。もともとの値に比べて13だけ増えていることは確実ですが、[メモ](firjal)にどんな値が入っていたのかが全く分からないので分かりません。「明示的に値を設定していない[メモ](firjal)にはどんな値が入っているのかは一般に分からない」のでしたね。</p>


<p><code>f0</code>を37だけ減らす、つまり、<code>37</code>という数値 [を](-'i) <code>f0</code> [から](-'c) [減じる](ny atakeses)には、次のように書きます。</p>

<div class="box">
<pre>
	nta 37 f0
</pre>
</div>

<p>もちろん、[メモ](firjal)の値を[住所箱](setistafar)に足し合わせることもできます。</p>

<div class="box">
<pre>
	ata f0 f1@
</pre>
</div>

<p><code>ata 13 f0</code>で13が変更されたりしないのと同じように、この命令で<code>f0</code>の値が変化することはありません。</p>

<p>なお、当然のことですが、数値を変更するような操作は許されません。</p>

<div class="error_box">
<pre>
	ata f2 3
</pre>
</div>

<p>練習として、住所4242149312にある値と、住所3274190944にある値を読み、それらの和を住所674147896に出力するようなプログラムを書くことを考えてみましょう。↓のように書けば正しく動くでしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
ata f0 f1@
kRz f1@ 674147896
</pre>
</div>

<p>いいえ、これでは上手くいきません。まず、3行目で<code>ata f0 f1@</code>とありますが、これでは増分は<code>f0</code>の値、つまり<code>4242149312</code>という数になってしまい、<code>4242149312</code>という住所にある値ではないからです。</p>
<p>では、こう直せばいいのでしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
ata f0@ f1@
kRz f1@ 674147896
</pre>
</div>

<p>いいえ、まだダメです。どこが間違っているか分かりますか？</p>
<p>そう、これでは「数値を変更する」ような命令になってしまいますので、これまた正しく動きません。では、こうすればよいのでしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
ata f0@ f1@
kRz 674147896 f2
kRz f1@ f2@
</pre>
</div>

<p>これはかなり惜しいところまで行っています。これは先程までの誤ったプログラムと違って、ちゃんと動いてくれます。ただし、思っていたのとは微妙に違う挙動になってしまうのです。さて、何が問題なのでしょう？</p>
<p>問題は、この操作の過程で<code>f1@</code>の値が変更されてしまうことです。結果の出力先は住所674147896であって、住所3274190944の値をこっそり変更してしまっては困ります。</p>
<p>では、こう直せば今度こそ大丈夫でしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
kRz 674147896 f2
kRz f1@ f3
kRz f0@ f2@
ata f3@ f2@
</pre>
</div>

<p>とても惜しい。誤植があります。<code>kRz</code>したのは<code>f3</code>ですが<code>ata</code>しているのは<code>f3@</code>ですね？</p>
<p>じゃあこうすればいいのでしょうか？</p>

<div class="dubious_box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
kRz 674147896 f2
kRz f1@ f3@
kRz f0@ f2@
ata f3@ f2@
</pre>
</div>

<p>これは動きますが、マズいです。<code>f3@</code>は[住所箱](setistafar)（しかもどの住所なのかよくわからない）で、そこを破壊してしまっているからです。</p>
<p>一時的な保管場所として使いたいのは<code>f3@</code>ではなく<code>f3</code>ですから、こうなります。</p>


<div class="box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
kRz 674147896 f2
kRz f1@ f3
kRz f0@ f2@
ata f3 f2@
</pre>
</div>

<p>これでやっと正しく動いてくれます。ふぅ。</p>

<p>なお、別解としては、次のような書き方もあります。</p>

<div class="box">
<pre>
kRz 674147896 f2
kRz 0 f2@
kRz 4242149312 f0
ata f0@ f2@
kRz 3274190944 f1
ata f1@ f2@
</pre>
</div>

<p>この方法は、書き換えてやることでレジスタを節約できるという利点もあります。</p>

<div class="box">
<pre>
kRz 674147896 f0
kRz 0 f0@
kRz 4242149312 f1
ata f1@ f0@
kRz 3274190944 f1
ata f1@ f0@
</pre>
</div>

<p>他にも、多少強引ですが「足してしまった分を引けば良い」という考えでこうしてやることもできます。</p>

<div class="box">
<pre>
kRz 4242149312 f0
kRz 3274190944 f1
kRz 674147896 f2
ata f0@ f1@
kRz f1@ f2@
nta f0@ f1@
</pre>
</div>

<p class="ny_jurli">まあ<code>f1@</code>が書き込み不可だった場合に落ちるんですけど、まあ例外機構はまだ無いのでそんなことは気にしない気にしない</p>

<h3>lexn.4 <code>kRz</code>命令の別用途</h3>

<p>ここまで、<code>kRz</code>・<code>ata</code>・<code>nta</code>と3種類の命令を学んできましたが、この3つの命令では今のところ数を複製したり足したりすることしかできません。また、足し算を何千回も繰り返すには、足し算命令を何千回を書くしかなさそうです。</p>
<p>…本当にそうでしょうか？なにか見落としはないでしょうか？もう一度2003fの基本動作を見ていきましょう。</p>

<ol>
	<li>xxが次の命令を指すようにする</li>
	<li>nxの指す命令を実行する</li>
	<li>xxの指す命令をnxも指すようにする</li>
</ol>

<p>ここで、「2. nxの指す命令を実行する」ことによって<code>xx</code>の値を上書きしたらどうなるでしょうか？「3. xxの指す命令をnxも指すようにする」によりその値が<code>nx</code>に伝播し、次の「1.」で新<code>nx</code>の次を<code>xx</code>が指すようになります。そうして新<code>nx</code>の指す命令が実行されるので、結果としては「上書きされたxxの指す場所に飛んでいって実行することができる」ということになります。</p>

<p>しかし、「上書きされたxxの指す場所に飛んでいく」といっても、飛んでいくべき場所が具体的にどんな数値で表されるのでしょう？今の我々にはそれを知る手段がありません。そのために使うのが <code>nll</code> というものです。</p>

<p><code>nll</code>は「[次に述べるもの](ny la lex)」の略で、直後に名前を書き、その後に命令を書くことで、その命令に名前を付けることができます。</p>

<p>つまり、</p>

<div class="box">
<pre>
kRz 3 f2 
nll polta1
ata f3 f2
kRz f0 f3@
</pre>
</div>

<p>と書くことで、<code>ata f3 f2</code>に対して<code>panqa</code>という名前を付けることができます。</p>

<p>なお、当然ながら、</p>

<div class="error_box">
<pre>
kRz 3 f2 
nll polta1
ata f3 f2
nll polta1
kRz f0 f3@
</pre>
</div>

<p>のように名前が重複することは禁止されていますし、</p>

<div class="error_box">
<pre>
kRz 3 f2 
nll f0
ata f3 f2
kRz f0 f3@
</pre>
</div>

<p>のように、既にfirjalの名前として使われているものを<code>nll</code>で使うのも禁止されています。</p>

<p>名前を付けた場所に飛んでいくためには、その名前を直接<code>xx</code>に<code>kRz</code>することで実現できます。</p>

<div class="box">
<pre>
kRz 3 f2
kRz polta1 xx
kRz 5 f2
nll polta1
fen
</pre>
</div>

<p>とすると、最後までたどり着いたときの<code>f2</code>の値は5ではなく3になります。</p>

<p>なお、ここでは<code>polta1</code>という名前を定義する前に<code>kRz polta1 xx</code>と書いていますが、これは許されます。</p>

<p>では、このように書くとどうなるでしょう？</p>

<div class="box">
<pre>
nll polta1
ata 1 f0
kRz polta1 xx
</pre>
</div>

<p>お分かりですね、永遠に<code>f0</code>に1を足し続け、いつまで経っても抜け出すことができません。</p>
<p>今まで実現できなかった「繰り返し」ができるようにはなったものの、決して抜け出せないのではそこまで役に立ちません。次は、そのような機構を実現するための方法について学んでいきましょう。</p>

<h3>lexn.5 <code>fi</code>と<code>malkRz</code></h3>

<p>繰り返しから途中で抜けるには、どうすればいいでしょう？</p>
<p>繰り返しというのは同じ命令列をひたすら実行していくことを指すのですから、そこから抜け出すには「状態に応じて、繰り返しの外に抜け出したり抜け出さなかったりする」ということを記述できる必要があるわけです。そのために用意されている命令が<code>fi</code>と<code>malkRz</code>です。</p>

<p><code>fi</code>と<code>malkRz</code>は組として使う命令で、次のように使います。</p>

<div class="box">
<pre>
fi f0 0 niv
malkRz 5 f1
</pre>
</div>

<p>これはつまり「[もし<code>f0</code>が0でなければ、5を<code>f1</code>に複製せよ](fi <code>f0</code> es 0 niv, mal krantairzarth 5'i <code>f1</code>'c.)」という意味です。</p>

<p>逆に、「<code>f0</code>が0である」という場合はどう書くのでしょうか？次のように書きます。</p>

<div class="box">
<pre>
fi f0 0 clo
malkRz 5 f1
</pre>
</div>

<p>この<code>clo</code>というのは「[同等だ](ce loler)」の省略です。「[もし<code>f0</code>が0と等しければ、](fi <code>f0</code> es 0 ce loler)」、ということですね。</p>

<div class="error_box">
<pre>
fi f0 0
malkRz 5 f1
</pre>
</div>

<p>とは書けないので注意しましょう。</p>

<p>また、</p>

<div class="box">
<pre>
fi f0 0 clo
malkRz 5 f1
</pre>
</div>

<p>の代わりに</p>

<div class="dubious_box">
<pre>
fi f0 0 clo
kRz 5 f1
</pre>
</div>

<p>と書いてしまうと、<code>malkRz</code>と違って<code>kRz</code>は無条件での複製を行う命令なので、これは</p>

<p>「<code>f0</code>は0と等しいだろうか？さてそんなことはどうでもよく、<code>f1</code>に5を入れてくれ」という命令になってしまいます。<strong>とてもありがちな誤りなので、十分注意しましょう</strong>。</p>

<p>さて、まずはこれを使って、<code>f1</code>の値の67倍を<code>f2</code>に入れる命令列を書いてみましょう。</p><p class="ny_jurli">いや、もちろん2003lkには掛け算命令もありますよ</p>

<p>もちろん、一番簡単なのは次のように書くことですが、</p>

<div class="box">
<pre>
kRz 0 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2   ata f1 f2
ata f1 f2   ata f1 f2
</pre>
</div>

<p>これでは面白みがないので、ちゃんと繰り返しを使って書いていきましょう。</p>

<p>例えば、このように書くことができます。</p>
<div class="box">
<pre>
kRz 0 f0
kRz 0 f2
nll polta1
ata f1 f2
ata 1 f0
fi f0 67 niv
malkRz polta1 xx
</pre>
</div>

<p>では、これを応用して、次のような実用的な課題を考えてみましょう。</p>

<p>「4187375140番地・4187375144番地・4187375148番地 … と番地を4ずつ増やして見ていって、住所箱のそこの値がf0の値と一致するならばその番地を、f1個探しても見つからなかったら0を、1923108072番地に書き込む。複数見つかった場合は、どの番地を知らせても良い。」</p>

<p>要するに、住所箱を見て、そのお隣さんを次々と調べていって、目的とする値を検索していくという課題です。</p>

<p>さて、このような問題に対していきなり完璧に対応しようとするとうまくいきません。まずは、課題の部分部分を考えるところから始めてみましょう。</p>

<p>まず、「4187375140番地を見て、f0の値と一致するなら1923108072番地に4187375140と書き込む」はどう書けばいいでしょうか？</p>

<div class="box">
<pre>
kRz 4187375140 f3
kRz 1923108072 f2
fi f3@ f0 clo
kRz 4187375140 f2@
</pre>
</div>

<p>と書くことで実現できます。</p>

<p>ここで、最後の行においても<code>f3</code>には4187375140という値が入ったまま（「4187375140番地の値」<strong>ではない！</strong>）であることに注意すると、次のようにも書けることが分かります。</p>

<div class="box">
<pre>
kRz 4187375140 f3
kRz 1923108072 f2
fi f3@ f0 clo
kRz f3 f2@
</pre>
</div>

<p>これで第1段階は解決です。次に、この直後に「4187375144番地を見て、f0の値と一致するなら1923108072番地に4187375144と書き込む」という処理を行うには、</p>

<div class="box">
<pre>
kRz 4187375140 f3
kRz 1923108072 f2
fi f3@ f0 clo
kRz f3 f2@

kRz 4187375144 f3
kRz 1923108072 f2
fi f3@ f0 clo
kRz f3 f2@
</pre>
</div>

<p>と書けばいいわけです。</p>

<p>ここで、5行目の段階では<code>f3</code>には4187375140という値が入ったままであり、<code>f2</code>には1923108072という値が入ったままであることを考えると、このように書けます。</p>


<div class="box">
<pre>
kRz 4187375140 f3
kRz 1923108072 f2
fi f3@ f0 clo
kRz f3 f2@

ata 4 f3
fi f3@ f0 clo
kRz f3 f2@
</pre>
</div>

<p class="ny_jurli">ここにちゃんとした説明を入れる。レジスタが足りないのでループカウンタに転用する話とか書きましょうね。</p>


<p>最終的に、</p>
<div class="box">
<pre>
kRz 4187375140 f3
kRz 1923108072 f2
kRz 0 f2@
nll polta1
fi f3@ f0 clo
kRz f3 f2@
ata 4 f3
nta 1 f1
fi f1 0 niv
malkRz polta1 xx
</pre>
</div>

<p>というのが正解の一つとなるわけです。</p>


<h3>lexn.6 二重移動命令<code>inj</code></h3>

<p><code>f0</code>に入っている値を<code>f1</code>に移し、<code>f1</code>に元々入っていた値は<code>f2</code>に移す、といった処理はどうやって書けばいいでしょうか？</p>

<p>簡単ですね。次のように書けばいいのです。</p>

<div class="box">
<pre>
kRz f1 f2
kRz f0 f1
</pre>
</div>

<p>これを一つの命令にまとめた、<code>inj</code>という命令があります。名称は[同時に移す](irzarst ileceonj)を略したもので、2回の<code>kRz</code>を同時に行うことができます。</p>


<div class="box">
<pre>
inj f0 f1 f2
</pre>
</div>

<p>これが特に便利なのは、値を交換したいときです。例えば、<code>f0</code>に入っている値と<code>f1@</code>に入っている値を交換したいとき、次のようには書けません。</p>


<div class="dubious_box">
<pre>
kRz f0 f1@
kRz f1@ f0
</pre>
</div>

<p>順番を入れ替えて</p>

<div class="dubious_box">
<pre>
kRz f0 f1@
kRz f1@ f0
</pre>
</div>

<p>としても、上手くいかないことに変わりはありません。</p>

<p>ということで、この場合は<code>inj</code>の「同時に移す」という性質を使って、</p>

<div class="box">
<pre>
inj f0 f1@ f0
</pre>
</div>

<p>と書くことで正しく交換できます。</p>

<div class="ny_jurli"> 
<ol>
	<li>第二オペランドの値を一時保管する</li>
	<li>第一オペランドの値を第二オペランドに入れる</li>
	<li>一時保管した値を第三オペランドに入れる</li>
</ol>という操作をこの順に行う行為と等価であることが保証されている。</div>

<p>なお、余談ですが、<code>inj</code>が要求する3要素のうち2番目に[メモ](firjal)を使っていて、かつ3番目が[住所箱](setistafar)であるとき、2番目で使っている[メモ](firjal)を住所箱の番地を指すためにも使うと不具合を起こすことがあります。気をつけましょう。例えば、

<div class="error_box">
<pre>
inj f0@ f0 f0@
</pre>
</div>

<p>は2003lkとしては正しくなくて、<code>f0</code>と<code>f0@</code>を交換したい場合は</p>

<div class="box">
<pre>
inj f0 f0@ f0
</pre>
</div>

<p>と記載する必要があります。</p>

<h3>lexn.7 <code>f5</code>と[指令](cersva)</h3>

<p>ここまでに<code>f0</code>, <code>f1</code>, <code>f2</code>, <code>f3</code>, <code>xx</code>を使ってきましたが、まだ活用していない[メモ](firjal)として<code>f5</code>があります。これは原理的には他の[メモ](firjal)と完全に対等ですが、慣用的に他のfirjalと異なった使い方をします。<code>f5</code>は通常[住所箱](setistafar)の番地を指し、「この番地より少し小さい番地は自由に使うことができるが、この番地以上は他人の支配下にある」という一種の縄張りを表します。</p>

<style type="text/css">
.k {white-space: nowrap;}
.free_mem {background-color: #ddddff;}
.occupied_mem {background-color: #ddffdd;}
</style>

<div class="machine_state_box">
<p><code>f5</code>が23976であるとき</p>
<table class="memory">
<tr>
	<td class="free_mem">自由</td>
	<td class="free_mem">自由</td>
	<td class="free_mem">自由</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
</tr>
<tr>
	<td class="k">23964番地</td>
	<td class="k">23968番地</td>
	<td class="k">23972番地</td>
	<td class="k">23976番地</td>
	<td class="k">23980番地</td>
	<td class="k">23988番地</td>
	<td class="k">23992番地</td>
</tr>
</table>
</div>

<p>この仕組みは、様々に活用できます。例えば、今まで少し複雑な処理を書いていて「firjalの数が足りない」と思ったことがあるかと思いますが、そういうときに計算途中の値を<code>f5</code>より少し小さい番地の住所に退避させることで問題を解決することができます。</p>

<p>例えば、だいぶ先になるまで現在の<code>f3</code>の値は使わないな、と感じたときには、</p>

<div class="box">
<pre>
nta  4 f5
kRz f3 f5@
</pre>
</div>

<p>と退避しておくことができます。こうすることで、2003fの状態は</p>

<div class="machine_state_box">
<p><code>f5</code>は23972</p>
<table class="memory">
<tr>
	<td class="free_mem">自由</td>
	<td class="free_mem">自由</td>
	<td class="occupied_mem">退避したf3の値</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
</tr>
<tr>
	<td class="k">23964番地</td>
	<td class="k">23968番地</td>
	<td class="k">23972番地</td>
	<td class="k">23976番地</td>
	<td class="k">23980番地</td>
	<td class="k">23988番地</td>
	<td class="k">23992番地</td>
</tr>
</table>
</div>

<p>となるので、後になって必要になったら、</p>

<div class="box">
<pre>
kRz f5@ f3
ata  4  f5 
</pre>
</div>

<p>としてやることで値を復活させられます。</p>

<div class="machine_state_box">
<p><code>f5</code>は23976</p>
<table class="memory">
<tr>
	<td class="free_mem">自由</td>
	<td class="free_mem">自由</td>
	<td class="free_mem">退避したf3の値</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
	<td class="occupied_mem">使用中</td>
</tr>
<tr>
	<td class="k">23964番地</td>
	<td class="k">23968番地</td>
	<td class="k">23972番地</td>
	<td class="k">23976番地</td>
	<td class="k">23980番地</td>
	<td class="k">23988番地</td>
	<td class="k">23992番地</td>
</tr>
</table>
</div>

<p>こうすると、操作をする前の元の状態に戻っていることを頭に入れましょう。厳密には23972番地の値が変わっていますが、なんせここは元から「自由」とされていたところなので、勝手に変更しても全く構わないのです。</p>


<p>このように、一時的な値の退避という面で<code>f5</code>はとても便利です。しかしながら、<code>f5</code>の一番のポイントは、[指令](cersva)という機構を実現するということにあります。</p>

<p>[指令](cersva)というのは、意味上ひとまとまりである処理に名前を付け、様々な場所から何回も使えるようにする仕組みです。[中央省](sysiten karmacist)が[国際協力院](kardzest ispien lefi'alir)に指令を出したとき、その指令を[国際協力院](kardzest ispien lefi'alir)が行う最中に[連邦外交院](kardzest fankasa'd iccesi'aviratust)にもう少し小さい指令を出す、ということは日常的にありますが、このようなことも2003fの[指令](cersva)では実現できます。</p>
<p>では、これを実現するのになぜ<code>f5</code>が必要なのか、<code>f5</code>をどう使うのか、学んでいきましょう。</p>

<p>とても簡単な[指令](cersva)として、<code>f0</code>, <code>f1</code>, <code>f2</code>, <code>f3</code>をゼロにする処理である</p>

<div class="box">
<pre>
kRz 0 f0
kRz 0 f1
kRz 0 f2
kRz 0 f3
</pre>
</div>

<p>という処理に<code>iumes</code>という名前を付けることを考えましょう。</p>

<p>まず、命令のまとまりに名前を付けるにはどうすればよいでしょう？これは既に学びました。</p>

<div class="box">
<pre>
nll iumes
kRz 0 f0
kRz 0 f1
kRz 0 f2
kRz 0 f3
</pre>
</div>

<p>次に、主処理の中で<code>iumes</code>という指令を出すことを考えましょう。<code>xx</code>を明示的に変更しない限り命令列は上から実行されますから、主処理は<code>iumes</code>より上に書いて、</p>

<div class="box">
<pre>
（ここに主処理がある）
kRz iumes xx

nll iumes
kRz 0 f0
kRz 0 f1
kRz 0 f2
kRz 0 f3
</pre>
</div>

<p>というふうに書きたいところです。</p>
<p>しかし、主処理から<code>iumes</code>という指令を出したら、指令が終わった後には主処理に復帰してそれを続行したいわけです。</p>

<p>では、次のようにすればよいのでしょうか？</p>

<div class="dubious_box">
<pre>
（ここに主処理がある）
kRz iumes xx
nll snusnijal
（ここに主処理の続きがある）

nll iumes
kRz 0 f0
kRz 0 f1
kRz 0 f2
kRz 0 f3
kRz snusnijal xx
</pre>
</div>

<p>いいえ、これでは主処理が終わった後でもう一回<code>iumes</code>を実行してしまいます。ということでこうしましょう。</p>


<div class="box">
<pre>
（ここに主処理がある）
kRz iumes xx
nll snusnijal
（ここに主処理の続きがある）
kRz lesback xx

nll iumes
kRz 0 f0
kRz 0 f1
kRz 0 f2
kRz 0 f3
kRz snusnijal xx

nll lesback
fen
</pre>
</div>

<p>これで完成でしょうか？</p>
<p>とりあえず、<code>iumes</code>というまとまりを作ってそれを分離することはできました。しかしこのままでは[指令](cersva)として使うには重大な欠陥があります。それは何でしょう？</p>

<p>答えは、「これでは再利用できない」ということです。たとえ他の場所で使いたいとしても、<code>snusnijal</code>は一つしかないのです。</p>

<p>つまり、<code>iumes</code>を2回使いたいとして、</p>

<div class="error_box">
<pre>
（主処理その1）
kRz iumes xx
nll snusnijal
（主処理その2）
kRz iumes xx
nll snusnijal
（主処理その3）
kRz lesback xx

nll iumes
kRz 0 f0
kRz 0 f1
kRz 0 f2
kRz 0 f3
kRz snusnijal xx

nll lesback
fen
</pre>
</div>

<p>と書いたところでどちらの<code>snusnijal</code>に行けばいいのか分からないのです。</p>

<p>これを解決するために、<code>f5</code>を使います。これを使って「戻るべき場所」を毎回退避しておくことで、<code>iumes</code>が終わった後に正しい場所に戻ることができるのです。</p>

<p>ということで、指令を出した側は「<code>f5</code>を4減らして場所を確保し、<code>f5@</code>に『指令から終わった後に戻るべき命令の場所』を入れておき、命令から戻ったら<code>f5</code>を4増やす」とすればよいでしょう。</p>

<p>それに対応して、指令を受けた側は「<code>f5@</code>には『戻るべき命令の場所』が入っているのだから、一連の処理が終わったら<code>f5@</code>を<code>xx</code>に入れる」とだけすればよいのです。</p>

<p>さて、ではこれを2003lkで書いてみましょう。</p>

<hr>
<footer style="text-align:right"><p>phil.2005年2月</p><p class="ny_jurli">…に執筆されたという設定。現世でこの文章を書いているのは西暦2017年の10月…からずっと放置して2018年の8月。</p><p class="ny_jurli">どうしようかな、ubpl開発以降の文章という設定にしてもいいんだけど。そっちの方が面白いかもな。</p></footer>


</body>
