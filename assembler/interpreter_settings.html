<!doctype html>
<html>
<head>
<title>インタプリタの追加設定一覧（暫定）</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="../common.css">
</head>
<body class="cool">
<p>以下ではインタプリタでの追加設定について書いていきます。雑記・考察ログを見たい人は<a href="../opcode.html">「オペコードなどについて考察する」</a>をお読みください。アセンブリ言語だけの最新の仕様だけ知りたい人は<a href="../settings.html">設定一覧</a>をお読みください。専門用語の一覧は<a href="https://sites.google.com/site/panqateel/yougo">用語集</a>に掲載されています。ソースコードの例としては<a href="../fib_non_recursive.jurli.html">非再帰フィボナッチ</a>と<a href="../fib_recursive.jurli.html">再帰フィボナッチ</a>と<a href="../qsort.jurli.html">quicksort</a>と<a href="../lakormeru.jurli.html">開平</a>があります。</p>

<h2>-1. 擬似ハードウェア</h2>
<p>擬似ハードウェアは擬似CPUと擬似メモリからなる。</p>
<h3>-1-1. 擬似メモリ</h3>
<p>アドレスをキーとして8bitを値とした連想配列である。書き込んでいない番地から読み込もうとしたときというのは高い確率でバグなので、番地を乱数種とした擬似乱数が返り、かつそのアクセスが別の場所にこっそり記録されるという仕様になっている。</p>
<h3>-1-1. 擬似CPU</h3>
<p>central processing unitとは名ばかりで、processingはインタプリタが代行してくれている以上、擬似CPUはレジスタとフラグからなる構造体のことに過ぎない。</p>

<h2>0. 全体の流れ</h2>
<p>コマンドライン引数で与えられたファイルを開き、構文解析してロードする。その段階のものをデバッグ出力し、次にロードしたものを実行する。その結果得られたログ（独自拡張であり、かつ現状では常に空）を出力したあと、仮想ハードウェアを出力して終了する。<code>-x</code>が与えられているときは、ロードしたもののログ出力はなく、代わりに各命令の実行前に毎回一時停止する。コマンドライン引数がない場合は、複数のサンプルファイルそれぞれに対し「ロード→デバッグ出力→実行」を行う。</p>

<h2>1. 構文解析</h2>
<p>セミコロンから行末までをコメントとし、無視する独自拡張が実装されている。</p>

<h2>2. ロード</h2>
<p>各命令に擬似乱数で仮の長さを割り振り、0x1482e8d4 = 344123604を起点として各命令にアドレスを割り振っていく。各命令の2進数表現が確定していない以上、当然擬似メモリ上には実際には命令は載っておらず、従って自己書き換えコードのようなことは実現できない。またこの時にラベルからアドレスを引く連想配列も作られ、<code>krz fistir xx</code>のような命令を実行するときには「その連想配列の中からアドレスを引き、それをxxに代入」といった処理となる。</p>

<h2>3. 実行</h2>
<p>基本的には、「nxの次の命令のアドレスをxxに入れ、nxの命令を取得する」→「nxの命令に従って擬似ハードウェアの値を変更していく」→「nxにxxの値をコピーする」だけである。</p>

<p>擬似ハードウェアの初期状態：</p>
<ul>
	<li>f0, f1, f2, f3, xx, flag: 不定</li>
	<li>f5: 0x6d7aa0f8 = 1836753144</li>
	<li>nx: ロードの起点である0x1482e8d4 = 344123604</li>
	<li>メモリ: 0x6d7aa0f8 = 1836753144 番地に値 0xbda574b8 = 3181737144が書き込まれている</li>
</ul>

<p>ロードされた命令に当たるアドレス以外の値がnxに入っていると、実行したときにエラーを吐く。ただし、nxが0xbda574b8 = 3181737144であるときはインタプリタが特別に解釈し、f5の値が初期値と同じである場合に限り処理が正常終了する。メモリの初期状態は「ゼロ引数の関数を呼んでおり、リターンアドレスは0xbda574b8 = 3181737144である」という状況である。要するに、インタプリタはゼロ引数関数を期待し実行し、関数が呼び出し規約を守っていれば正常終了することを期待しているのである。</p>

<h2>4. 組み込み関数</h2>
<p>インタプリタには以下の組み込み関数がある。</p>
<table>
	<tr><td>関数のアドレス</td><td>引数の数</td><td>挙動</td></tr>
	<tr><td>3126834864</td><td>1</td><td>引数を何らかの場所にデバッグ出力する。</td></tr>
</table>

<h2>5. メモリ</h2>
<p>0xa0000000 - 0xaffffffc、つまり2684354560〜2952790012のメモリ空間はインタプリタ側では用いないので、将来の衝突の心配なくユーザー側で用いることができる。</p>


</body>