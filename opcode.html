<!doctype html>
<html>
<head>
<title>オペコードなどについて考察する</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="common.css">
</head>
<body class="cool">
<h1>オペコードなどについて考察する</h1>

<p>以下のは雑記・考察ログです。<strong style="font-size: 120%">すでに絶滅した過去の仕様などが数多く含まれています。</strong>最新の仕様だけ知りたい人は<a href="settings.html">設定一覧</a>をお読みください。専門用語の一覧は<a href="https://sites.google.com/site/panqateel/yougo">用語集</a>に掲載されています。インタプリタで実装されている追加仕様などについては<a href="assembler/interpreter_settings.html">インタプリタの追加設定一覧（暫定）</a>を参照ください。Twitterで出た質問はTogetterにまとめてあります（<a href="https://togetter.com/li/1151279">part1</a>, <a href="https://togetter.com/li/1153844">part2</a>, <a href="https://togetter.com/li/1156125">part3</a>）。ソースコードの例としては<a href="fib_non_recursive.jurli.html">非再帰フィボナッチ</a>と<a href="fib_recursive.jurli.html">再帰フィボナッチ</a>と<a href="./qsort.jurli.html">quicksort</a>と<a href="lakormeru.jurli.html">開平</a>があります。</p>

<h2>1. 設定</h2>
<s> <a href="https://docs.google.com/spreadsheets/d/1AUex8DDU9n5r-q27MD-6_aW5en-vmXZ55ptzm91yV74/edit#gid=0">Google SpreadSheetで作業中</a></s><b>OBSOLETE:: 2017/08/29 23:40時点で既に部分的に無効</b>
<pre>
2017/08/28:
呼び出し規約を確定させる
スタックの掃除をするのは呼び出し側
いじって良いレジスタは4個 (f0 ~ f3)
引数は前からスタックに積む
戻り値は単純型ならレジスタ (f0) でやり取り
</pre>

<h2>2. 実践</h2>
<p>さて、呼び出し規約も決まったことだし色々書いていきますかね。とりあえずフィボナッチ書こう。スタックを管理するのは（ダイスロール）f5ですな。まずはCっぽく。</p>
<pre>
int fib(int a)
{
	register int f0 = a;
	register int f1 = 0; 
	register int f2 = 1;
	register int f3;
	while(f0) {
		f0--;
		f3 = f1 + f2;
		f1 = f2;
		f2 = f3;
	}
	f0 = f1;
	return f0;
}
</pre>
<p>解説</p>
<table>
<tr><td>f0<td>5<td>4<td>4<td>3<td>3<td>2<td>2<td>1<td>1<td>0<td>0<td>5
<tr><td>f1<td>0<td>0<td>1<td>1<td>1<td>1<td>2<td>2<td>3<td>3<td>5<td>
<tr><td>f2<td>1<td>1<td>1<td>1<td>2<td>2<td>3<td>3<td>5<td>5<td>8<td>
<tr><td>f3<td> <td>1<td> <td>2<td> <td>3<td> <td>5<td> <td>8<td> <td>
</table>
<p>x86風に書いてみる</p>
<pre>
	MOV f0 [ESP+4]
	MOV f1 0
	MOV f2 1
a:	EQU f0 0
	J_C b <span class="comment">;フラグを見てジャンプ</span>
	ADD f0 -1
	MOV f3 f1
	ADD f3 f2
	MOV f1 f2
	MOV f2 f3
	JMP a
b:	MOV f0 f1
	JMP [ESP]
	ADD ESP 4

</pre>

<p>リパに翻訳</p>
<pre>
	krz f0 [f5+4]
	krz f1 0
	krz f2 1
is:	sie f0 0
	J_C ka <span class="comment">; どうしよう</span>
	ata f0 -1
	krz f3 f1
	ata f3 f2
	krz f1 f2
	krz f2 f3
	krz xx is
ka:	krz f0 f1
	krz xx [f5]
	ata f5 4
</pre>

<p>というか、自明に「xxをいじる = ジャンプ」なので、ジャンプ命令を作ってそれを<code>krz xx abcde</code>と書いても良い設定にすればよい。ファイクレオネにはWPのおかげで既にワープ・瞬間移動・縮地法の類がありそうなので、それを流用するのが自然な気がする。</p>

<h2>3. 設定part2</h2>
<p>2で出てきた設定を（明示・暗黙共に）まとめる。</p>
<ul>
<li>スタックを管理するのはf5</li>
<li>xxレジスタには「次に実行する命令のアドレス」が格納されている。CPUは<ruby><rb>針</rb><rt>プログラムカウンタ</rt></ruby>を持っていて、ひたすら「<a id="geasz"><s>xxを1増やす</s> <b><a href="#bgsd">嘘です。</a></b></a>→針の指す命令を実行する→xxの指す位置に針を動かす」を繰り返す、と。</li>
<li>無条件ジャンプ・条件ジャンプは共に、内部構造としては「xxを上書きする命令」である。ただ、<code>krz</code>命令では代用できない（「フラグを見てkrzするか決める」という命令はないため）ので、別命令として作り<code>krz xx iska</code>もジャンプ命令に翻訳、という感じ？いや待て、『「フラグを見てkrzするか決める」という命令はない』など誰が言った？あってもええやん！（後世が投機実行の実装に苦しむ図）（でもオモロイやん採用）</li>
<li>ということで「フラグを見て代入するかどうか決める」命令を考えよう</li>
</ul>

<h2>4. Fafs falira sashimiと打ち合わせ</h2>
<p>「フラグを見て代入するかどうか決める」命令をどうすべきか迷ったので、<a href="conversations/redefine_comparison.txt">打ち合わせを行った</a>。その結果、比較演算子系統のニーモニックが全部作り直しになった。</p>

<h3>4-1. 結果</h3>
<div class="box">
<p>基本構文：</p>
<pre>
fi <u>第一オペランド</u> <u>第二オペランド</u> <u>比較表現</u>
malkrz <u>レジスタ</u> <u>値</u>
</pre>
</div>
<div class="box">
<p>例：</p>
<pre>
fi f0 f1 lloler
malkrz f2 f3
</pre>
</div>
<p>この構文は、上記の例に即するなら、Fi f0 es f1 le loler, mal krantairzarth f2'c f3'i. 「f0がf1よりも大きいならば、f3をf2にコピーする」というリパライン語表現にちょうど対応する。</p>

<h3>4-2. 念のため補足</h3>

<p>もちろん、実際の処理としては、【<code>fi ~ lloler</code>命令は「第一オペランドが第二オペランドよりも大きいならばフラグを立てる」命令であり、<code>malkrz</code>命令が「フラグが立っているときにのみ第一オペランドに第二オペランドの値を代入する」命令である】ということであり、自然なリパライン語として読めるかどうかということは正しいアセンブリ言語になるかどうかとは当然別物である。</p>

<p>その証拠に、リパライン語では上記の文をFi f0 es f1 le loler, krantairzarth f2'c f3'i.というふうにmalという語を抜かして表現しても意味は変わらないが、</p>
<pre>
fi f0 f1 lloler
krz f2 f3
</pre>
<p>は当然「f0がf1よりも大きいならばフラグを立てる。さてそれはともかくf3をf2にコピーする」という別の意味の命令群になる。リパラオネ人がこの仕様に苦しむのは、まるで現世でC系統の言語を習い始めた人が<code>if(a = 0)</code>とか<code>if(a == 0||1)</code>とか書いてしまうようなものである。</p>


<h2>5. 実践part2</h2>
<p>ということで、4.に基づき前述のフィボナッチを修正していこう。</p>
<pre>
	krz f0 [f5+4]
	krz f1 0
	krz f2 1
is:	fi f0 0 cloler <span class="comment">; ce loler</span> 
	malkrz xx ka 
	ata f0 -1
	krz f3 f1
	ata f3 f2
	krz f1 f2
	krz f2 f3
	krz xx is
ka:	krz f0 f1
	krz xx [f5]
	ata f5 4
</pre>

<p>よし、これで初めての関数である。やったー。</p>

<p>しかし、<code>cloler</code>がやっぱりちょっと長い気がするなぁ（他が短すぎるだけともいう）</p>

<p>さて、じゃあ再帰フィボナッチも実装しましょうかね。まずはC</p>

<pre>
int fib2(int a)
{
	register int f0 = a;
	register int f1;
	register int f2;

	if(f0 < 2) {
		goto fin;
	}

	f1 = f0;
	f1--;
	f0 = fib2(f1);
	f2 = f0;
	f1--;
	f0 = fib2(f1);
	f2 += f0;
	f0 = f2;

	fin:
	return f0;
}
</pre>

<p>まずはx86もどき混じりで翻訳。</p>

<pre>
fib2:	krz f0 [f5+4]
	fi f0 2 xyloler
	malkrz xx iska
	krz f1 f0
	ata f1 -1
	PUSH f1
	CALL fib2
	POP f1 <span class="comment">;関数呼び出しでf1が破壊されるので修復</span>
	krz f2 f0
	ata f1 -1
	PUSH f2
	PUSH f1
	CALL fib2
	POP
	POP f2
	ata f2 f0
	krz f0 f2
iska:	RET
</pre>

<p>次に、関数呼び出しとスタック操作について整理しよう。</p>

<div class="box">
<p>スタックにiskaをプッシュする</p>
<pre>
	ata f5 -4	<span class="comment">; f5を持ち上げて</span>
	krz [f5] iska	<span class="comment">; 積む</span>
</pre>
</div>

<div class="box">
<p>スタックをポップしてiskaに代入</p>
<pre>
	krz iska [f5]	<span class="comment">; スタックの値を代入</span>
	ata f5 4	<span class="comment">; f5を下げる</span>
</pre>
</div>

<div class="box">
<p>return f0;</p>
<pre>
	krz xx [f5]	<span class="comment">; リターンアドレスに飛んで</span>
	ata f5 4	<span class="comment">; スタックからリターンアドレスを削除</span>
</pre>
</div>

<div class="box" style="border:1px solid red">
<p>f0 = func();</p>
<pre>
	<span class="comment">; えっと、</span>
	ata f5 -4	<span class="comment">; スタックにリターンアドレスを</span>
	krz [f5] xx	<span class="comment">; 積む</span>
	krz xx func	<span class="comment">; 関数のアドレスにジャンプ</span>
	<span class="comment">; でいいのかな？</span>
	<span class="comment">; いいえ。積んだときのxxはkrz xx funcを指しています。よってこれでは無限ループします</span>
	<span class="comment">; さてどうしよう。</span>
	<span class="comment">; 普通ならここで素直にCALLのニーモニックを作ればいいんだろうが、2003'd ferlesylの作者は全部をxxへの操作としたがる人だ</span>
	<span class="comment">; そうだ、2つのkrzを1回で行う命令を作ればいいんだ</span>
	<span class="comment">; 名前はqa stevypo krzの略でqskrzとでもすればいいか。</span>
	<span class="comment">; krz fi stの後にkrz st irをすることをqskrz fi st irと書けることにすればよい。</span>
	<span class="comment">; 実際処理としてよくありそうなやつだし。汎用性あるし採用していいでしょ</span>
	<span class="comment">; ということで仕切り直し</span>
</pre>
</div>


<div class="box">
<p>f0 = func();</p>
<pre>
	ata f5 -4	<span class="comment">; スタックを準備</span>
	qskrz [f5] xx func	<span class="comment">; リターンアドレスを積んで、同一命令で関数のアドレスにジャンプ</span>
</pre>
</div>

<p>CALLの実装書いてて気づいたけど、<a id="bgsd">前に<a href="#geasz">xxを1増やす</a>って書いたの嘘やん。</a>固定長でもないし1byteでもないもん。単純に「次の命令を指すところにxxが移動する」ですな。</p>

<p>さて、ここまでやったところで翻訳。</p>
<pre>
fib2:	krz f0 [f5+4]
	fi f0 2 xyloler
	malkrz xx iska
	krz f1 f0
	ata f1 -1
	ata f5 -4
	krz [f5] f1
	ata f5 -4
	qskrz [f5] xx fib2
	krz f1 [f5]
	ata f5 4
	krz f2 f0
	ata f1 -1
	ata f5 -4	
	krz [f5] f2
	ata f5 -4	
	krz [f5] f1
	ata f5 -4
	qskrz [f5] xx fib2
	krz f2 [f5+4]
	ata f5 8
	ata f2 f0
	krz f0 f2
iska:	krz xx [f5]
	ata f5 4
</pre>

<h2>6. 課題</h2>
<p>まず、5に出てきた新規設定をまとめる。</p>
<ul>
<li>ce lolerはcloler、xy lolerはxyloler</li>	
<li>krz fi stの後にkrz st irをすることをqskrz fi st irと書けることにする。2で出てきた非再帰フィボナッチでも使うことのできる汎用性の高い命令。</li>	
<li>CPUは<ruby><rb>針</rb><rt>プログラムカウンタ</rt></ruby>を持っていて、ひたすら「次の命令を指すところにxxを移動させる→針の指す命令を実行する→xxの指す位置に針を動かす」を繰り返す</li>
</ul>
<p>この2番目と3番目を組み合わせると、なんと関数呼び出しが実行できるのである。</p>
<p>また、slackで出てきた課題について述べる。</p>
<ul>
<li>「オペランドの順番どうする？」
</li><li>「[fistir]というx86由来の表記法をどうにかしたい」
</li><li>「色んな名前空間が衝突しているぞ。ラベルとニーモニックと関数名とレジスタ名と。」
</li><li>「他が3文字4文字の中でllolerって長いのでは」
</li></ul>

<p>待てよ？qskrz fi st irをCでいう「fi = st; st = ir;」ではなく「tmp = st; st = ir; fi = tmp;」であると再定義してやれば、上記のコードに一切の変更を与えずかつfiとirが同一であるときXCHGとして使えるのでは！？これは楽しいぞ。とりあえず命令名を変えなくては。Fafs氏に訊こう。</p>
<img src="img/qskrz.png" height="100"/>
<hr>
<p>Fafs「qa'd stevypen snidost「二回移動」でqssでいかがでしょうか」</p>
<p>なるほど。まあ片方が移動で片方がコピーなのだが、fi = irのときはswapだしまあよかろう。</p>

<p>llolerについても反応を得た。「lloとでもすればいいのじゃろうなあ」とのこと。同意。</p>
<p>語順についても反応を得た。リパラオネ人は-'i -'cを好むらしい。となると再設計か？めんどい。とは言え、バート人は-'c -'iを好むそうだ。じゃあ「設計者はバート人だったので無意識のうちにV -'c -'iでデザインしていたが、リパラオネ人に-'i -'cの方が自然だと言われた。とはいえ既存のコードを全部修正するのは面倒だったので『ci指定擬似命令』をアセンブリに組み込んだ」という設定にしよう。</p>


<h2>7. 実践part3</h2>
<p>とりあえず、仕様がそれなりに変わったので書き直す。</p>
<div class="box">
<p>非再帰フィボナッチ</p>
<pre>
::'c'i
	krz f0 [f5+4]
	krz f1 0
	krz f2 1
is:	fi f0 0 clo
	malkrz xx ka 
	ata f0 -1
	krz f3 f1
	ata f3 f2
	qss f1 f2 f3
	krz xx is
ka:	krz f0 f1
	krz xx [f5]
	ata f5 4
</pre>
</div>

<div class="box">
<p>再帰フィボナッチ</p>
<pre>
::'c'i
fib2:	krz f0 [f5+4]
	fi f0 2 xylo
	malkrz xx iska
	krz f1 f0
	ata f1 -1
	ata f5 -4
	krz [f5] f1
	ata f5 -4
	qss [f5] xx fib2
	krz f1 [f5]
	ata f5 4
	krz f2 f0
	ata f1 -1
	ata f5 -4	
	krz [f5] f2
	ata f5 -4	
	krz [f5] f1
	ata f5 -4
	qss [f5] xx fib2
	krz f2 [f5+4]
	ata f5 8
	ata f2 f0
	krz f0 f2
iska:	krz xx [f5]
	ata f5 4
</pre>
</div>

<p>角かっこ記法・名前空間の衝突などまだ課題は残るが、とりあえずクイックソートでも書くか。まずはC</p>

<pre>
void quicksort(int* const a, int l, int r)
{
	register int* const f0 = a;
	register int f1 = l; 
	register int f2 = r;
	register int f3;
	if(f1 >= f2) {
		goto fin;
	}
	f3 = f1;
	f3++;
	
panqa:
	if(f3 > r) {
		goto fistir;
	}
	f2 = l;
	f2 = f0[f2];
	if(f0[f3] >= f2) {
		goto iska;
	}
	f1++;
	qss(f0[f3],f0[f1],f0[f3]);
iska: 
	f3++;
	goto panqa;

fistir:
	f2 = l;
	qss(f0[f1],f0[f2],f0[f1]);

	int p = f1;
	quicksort(a,l,p-1);
	quicksort(a,p+1,r);
fin:	
	return;	
}
</pre>

<p>うわぁ（うわぁ）。とりあえずハンドコンパイルせねば</p>

<pre>
::'c'i
ycax:
	krz f2 [f5+4] ; r
	krz f1 [f5+8] ; l
	krz f0 [f5+12] ; a
	fi f1 f2 xolo
	malkrz xx lus
	krz f3 f1
	ata f3 1
panqa:
	fi f3 [f5+4] llo
	malkrz xx fistir
	krz f2 [f5+8]
	krz f2 [f0+f2]
	fi f2 [f0+f3] xtlo
	malkrz xx iska
	ata f1 1
	qss [f0+f3] [f0+f1] [f0+f3]
iska:
	ata f3 1
	krz xx panqa
fistir:
	krz f2 [f5+8]
	qss [f0+f1] [f0+f2] [f0+f1]

	ata f5 -4
	krz [f5] f1 ; push p
	ata f5 -4
	krz [f5] [f5+20] ; push a
	ata f5 -4
	krz [f5] [f5+20] ; push l
	ata f5 -4
	krz f1 [f5+12] ; f1 = p
	ata f1 -1
	krz [f5] f1 ; push p-1
	ata f5 -4
	qss [f5] xx ycax
	ata f5 4 ; aはconstなのでスタックに残っているaを信用してよい
	krz f1 [f5+8] ; f1 = p
	ata f1 1
	krz [f5] f1 ; push p+1
	ata f5 -4
	krz [f5] [f5+20] ; push r
	ata f5 -4
	qss [f5] xx ycax
lus:
	krz xx [f5]
	ata f5 4
</pre>
<p>疲れた。うーん、<code>ata</code>が多いのが気に入らないなぁ</p>

<h2>8. 設定</h2>
<p>書き忘れてた設定を思い出したので書いておく。<a id="nta">nta fistir'c 即値'iはata fistir'c (-即値)'iに翻訳される</a>。上記アセンブリでひたすら<code>ata</code>を使っているのはそういう理由である。</p>
<p>また、符号付きと符号なしを明示的に区別しないほうが楽だよなーとも思っているが、問題は大小比較。今までのコードは正数と負数の比較をしていないのでどちらでもいいんだが、両方用意するとか決めるとかしないとなぁ。</p>

<p>あと、notequalを除いて比較命令が出揃ったので掲載しよう。</p>
<table>
<tr><td>fi ~ xtlo</td><td>fi * es * xut loler</td><td>以下ならフラグを立てる</td></tr>
<tr><td>fi ~ xylo</td><td>fi * es * xy loler</td><td>未満ならフラグを立てる</td></tr>
<tr><td>fi ~ clo</td><td>fi * es * ce loler</td><td>同等ならフラグを立てる</td></tr>
<tr><td>fi ~ xolo</td><td>fi * es * xo loler</td><td>以上ならフラグを立てる</td></tr>
<tr><td>fi ~ llo</td><td>fi * es * le loler</td><td>超過ならフラグを立てる</td></tr>
</table>
<p>そしてこれを<a href="https://docs.google.com/spreadsheets/d/1CmGt_wHdcunhyJv2pp58pwNQwhx4yoZ47rz7LmlvKV4/edit#gid=1597275252">spreadsheet</a>と<a href="https://sites.google.com/site/panqateel/alml">サイト</a>の両方に載せて来た。</p>

<p>あ、あとqssとmalkrzを足してこよう。</p>


<h2>9. 格組の統一</h2>
<p>とりあえず、現状のニーモニック表を貼るとこうなる。</p>
<table border="1" bordercolor="#888" cellspacing="0" class="qq">
<tbody>
<tr>
<td style="width:51px;height:18px">&nbsp;命令</td>
<td style="width:126px;height:18px">&nbsp;語源</td>
<td style="width:60px">&nbsp;x86</td>
<td style="width:287px;height:18px">&nbsp;意味</td>
</tr>
<tr>
<td style="width:71px;height:18px">&nbsp;krz</td>
<td style="width:136px;height:18px">&nbsp;krantairzarth</td>
<td style="width:60px">&nbsp;mov</td>
<td style="width:287px;height:18px">&nbsp;複製</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;ata</td>
<td style="width:116px;height:18px">&nbsp;atakes</td>
<td style="width:60px">&nbsp;add</td>
<td style="width:287px;height:18px">&nbsp;加算</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;nta</td>
<td style="width:116px;height:18px">&nbsp;ny atakes</td>
<td style="width:60px">&nbsp;sub</td>
<td style="width:287px;height:18px">&nbsp;減算</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;stu</td>
<td style="width:116px;height:18px">&nbsp;stusni</td>
<td style="width:60px">&nbsp;mul</td>
<td style="width:287px;height:18px">&nbsp;乗算</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;kak</td>
<td style="width:116px;height:18px">&nbsp;kakites</td>
<td style="width:60px">&nbsp;div</td>
<td style="width:287px;height:18px">&nbsp;除算</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;ada</td>
<td style="width:116px;height:18px">&nbsp;adal</td>
<td style="width:60px">&nbsp;and</td>
<td style="width:287px;height:18px">&nbsp;ビット積</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;ekc</td>
<td style="width:116px;height:18px">&nbsp;ekcan</td>
<td style="width:60px">&nbsp;or</td>
<td style="width:287px;height:18px">&nbsp;ビット和</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;nac</td>
<td style="width:116px;height:18px">&nbsp;nacis</td>
<td style="width:60px">&nbsp;not</td>
<td style="width:287px;height:18px">&nbsp;ビット反転</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;dal</td>
<td style="width:116px;height:18px">&nbsp;daliual</td>
<td style="width:60px">&nbsp;xnor</td>
<td style="width:287px;height:18px">&nbsp;ビットxnor</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;tod</td>
<td style="width:116px;height:18px">&nbsp;tesnokon dusnij</td>
<td style="width:60px">&nbsp;shr</td>
<td style="width:287px;height:18px">&nbsp;右シフト</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;rod</td>
<td style="width:116px;height:18px">&nbsp;restuton dusnij</td>
<td style="width:60px">&nbsp;shl</td>
<td style="width:287px;height:18px">&nbsp;左シフト</td>
</tr>
<tr>
<td>&nbsp;malkrz</td>
<td style="width:100px">&nbsp;mal krantairzarth</td>
<td>
</td>
<td>&nbsp;フラグが立っているときのみ複製する
</td>
</tr>
<tr>
<td>&nbsp;fi ~ xtlo</td>
<td>&nbsp;fi * es * xut loler</td>
<td></td>
<td>&nbsp;以下ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fi ~ xylo</td>
<td>&nbsp;fi * es * xy loler</td>
<td></td>
<td>&nbsp;未満ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fi ~ clo</td>
<td>&nbsp;fi * es * ce loler</td>
<td></td>
<td>&nbsp;同等ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fi ~ xolo</td>
<td>&nbsp;fi * es * xo loler</td>
<td></td>
<td>&nbsp;以上ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fi ~ llo</td>
<td>&nbsp;fi * es * le loler</td>
<td></td>
<td>&nbsp;超過ならフラグを立てる</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;fen</td>
<td style="width:116px;height:18px">&nbsp;fav es niv e'i</td>
<td style="width:60px">&nbsp;nop<br>
</td>
<td style="width:287px;height:18px">&nbsp;何もしない</td>
</tr>
<tr>
<td style="width:51px;height:18px">&nbsp;qss<span>&nbsp; &nbsp;</span></td>
<td style="width:116px;height:18px">&nbsp;qa'd stevypen snidost</td>
<td style="width:60px">&nbsp;</td>
<td style="width:287px;height:18px">&nbsp;二重移動 (第1オペランドの値を第2オペランドに代入しつつ第2オペランドの古い値を第3オペランドに代入)</td>
</tr>
</tbody>
</table>

<p>さて、6.の最後で『ci指定擬似命令』なるものを導入した以上、基本的にニーモニックはリパライン語で-'i -'cの形となる動詞に由来すべきである。比較命令はともかく。</p>
<ul>
<li>まず、atakesは「-'sを-'iに加算」なので、atakes → atakeses「-'sは-'iを-'cに加算」に変更。</li>
<li>次に、stusniは「(-'sは-'iと-'cを)(計算)かけたものである」なので、紆余曲折の結果latvaves「-'sは-'cに-'iを掛け合わせる」という用語をでっち上げることに。</li>
<li>adalについてもadales「-'sは-'iというANDマスクを-'cにかぶせる」を作成。その勢いでdaliuales「-'sは-'iというXNORマスクを-'cにかぶせる」も。</li>
<li>シフト命令に関しては、命令文にするために副詞を後ろに。結果dtoとdroとなる。</li>
<li>qssも再命名、irzarst ileceonj「同時に移す」略してinjとなる。</li>
<li>nacisもnacises「-'sは-'iを反転させる」、【電算】「-'sは-'iの全ビットを反転させる」を造語</li>
</ul>

<p>ということで、作業が終わった。除算は仕様すら決めていないので後で考えることにして、とりあえず新しくなった表を持ってこよう</p>
<table border="1" bordercolor="#888" cellspacing="0" class="qq">
<tbody>
<tr>
<td>&nbsp;命令</td>
<td>&nbsp;語源</td>
<td>&nbsp;x86</td>
<td>&nbsp;意味</td>
</tr>
<tr>
<td style="width:71px;height:18px">&nbsp;krz</td>
<td style="width:116px;height:18px">&nbsp;krantairzarth</td>
<td style="width:60px">&nbsp;mov</td>
<td style="width:287px;height:18px">&nbsp;複製</td>
</tr>
<tr>
<td>&nbsp;ata</td>
<td>&nbsp;atakeses</td>
<td>&nbsp;add</td>
<td>&nbsp;加算</td>
</tr>
<tr>
<td>&nbsp;nta</td>
<td>&nbsp;ny atakeses</td>
<td>&nbsp;sub</td>
<td>&nbsp;減算</td>
</tr>
<tr>
<td >&nbsp;lat</td>
<td >&nbsp;latvaves</td>
<td >&nbsp;mul</td>
<td >&nbsp;乗算</td>
</tr>
<tr>
<td>&nbsp;(kak)</td>
<td>&nbsp;(kakites)</td>
<td>&nbsp;div</td>
<td>&nbsp;除算</td>
</tr>
<tr>
<td>&nbsp;ada</td>
<td>&nbsp;adales</td>
<td >&nbsp;and</td>
<td>&nbsp;ビット積</td>
</tr>
<tr>
<td>&nbsp;ekc</td>
<td>&nbsp;ekcan</td>
<td>&nbsp;or</td>
<td>&nbsp;ビット和</td>
</tr>
<tr>
<td>&nbsp;nac</td>
<td>&nbsp;nacises</td>
<td>&nbsp;not</td>
<td>&nbsp;ビット反転</td>
</tr>
<tr>
<td>&nbsp;dal</td>
<td>&nbsp;daliuales</td>
<td>&nbsp;xnor</td>
<td>&nbsp;ビットxnor</td>
</tr>
<tr>
<td>&nbsp;dto</td>
<td>&nbsp;dusnij&nbsp;tesnokonj</td>
<td>&nbsp;shr</td>
<td>&nbsp;右シフト</td>
</tr>
<tr>
<td>&nbsp;dro</td>
<td>&nbsp;dusnij restutonj</td>
<td>&nbsp;shl</td>
<td>&nbsp;左シフト</td>
</tr>
<tr>
<td>&nbsp;malkrz</td>
<td>&nbsp;mal krantairzarth</td>
<td>
</td>
<td>&nbsp;フラグが立っているときのみ複製する
</td>
</tr>
<tr>
<td>&nbsp;fi ~ xtlo</td>
<td>&nbsp;fi * es * xut loler</td>
<td></td>
<td>&nbsp;以下ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fi ~ xylo</td>
<td>&nbsp;fi * es * xy loler</td>
<td></td>
<td>&nbsp;未満ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fi ~ clo</td>
<td>&nbsp;fi * es * ce loler</td>
<td></td>
<td>&nbsp;同等ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fi ~ xolo</td>
<td>&nbsp;fi * es * xo loler</td>
<td></td>
<td>&nbsp;以上ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fi ~ llo</td>
<td>&nbsp;fi * es * le loler</td>
<td></td>
<td>&nbsp;超過ならフラグを立てる</td>
</tr>
<tr>
<td>&nbsp;fen</td>
<td>&nbsp;fav es niv e'i</td>
<td>&nbsp;nop<br>
</td>
<td>&nbsp;何もしない</td>
</tr>
<tr>
<td>&nbsp;inj<span>&nbsp;&nbsp;</span></td>
<td>&nbsp;irzarst ileceonj</td>
<td>&nbsp;</td>
<td style="width:287px;height:18px">&nbsp;二重移動 (第1オペランドの値を第2オペランドに代入しつつ第2オペランドの古い値を第3オペランドに代入)</td>
</tr>
</tbody>
</table>

<p>いぇーい。</p>

<h2>10. 整理</h2>

<h3>10-1. 細かい追加事項</h3>
<ul>
<li>アーキテクチャ名は「2003'd ferlesyl」(2003処理器)となった。<a href="https://jurliyuuri.slack.com/archives/C6QL0DKV4/p1504023443000051">出典1</a> <a href="https://twitter.com/hsjoihs/status/903265422362869760">出典2</a></li>
<li>「<a href="https://jurliyuuri.slack.com/archives/C6QL0DKV4/p1504285915000437">マルウェアの歴史欲しいよね</a>、<a href="https://jurliyuuri.slack.com/archives/C6QL0DKV4/p1504285923000525">コンピューターセキュリティ史</a>。」って話が出た。実際メモリ保護機構とかに絡んでくるはずではある。</li>
<li>OSを開発するグループ名が<a href="http://www.jurliyuuri.info/wiki/%E9%80%A3%E9%82%A6%E6%83%85%E5%A0%B1%E5%87%A6%E7%90%86%E7%A0%94%E7%A9%B6%E6%89%80">連邦情報処理研究所</a>に決まりました</li>
</ul>

<h3>10-2. ソースコード分離</h3>
<p>いちいちソースコードを掲載するのも紙面を圧迫しそうなので、ファイルを分離して管理することにした。まずはもともと分離してあった<a href="./qsort.jurli.html">quicksort</a>から。qssをinjに書き換えて、フォントをjietodenにするのも忘れずに。</p>
<p>うーん、やはり角かっこを滅ぼしたいよなぁ</p>
<p>さて、次はフィボナッチを整理するか。とはいえ初期から色々変更点が溜まっているが大丈夫だろうか</p>

<h3>10-3. 課題</h3>
<p>未解決のを列挙していこう。さらに新規に見つかったやつも。</p>
<ul>
<li>角かっこを滅ぼさねば</li>
<li>色んな名前空間が衝突しているぞ。ラベルとニーモニックと関数名とレジスタ名と。</li>
<li>負数ってリパライン語圏でどう表記するの？</li>
</ul>

<h3>10-4. マニュアル分離</h3>
<p>レジスタ一覧とニーモニック一覧が欲しいと言われたので、<a href="settings.html">作った。</a></p>

<h3>10-5. ソースコード分離part2</h3>
<p>ソースコードのフォントを切り替えられる設定にした。あと、とりあえず<a href="fib_non_recursive.jurli.html">非再帰フィボナッチ</a>と<a href="fib_recursive.jurli.html">再帰フィボナッチ</a>のソースコードを独立ファイルとして公開。</p>

<h3>10-6. 課題解決案</h3>
<p><a href="#nta">nta fistir'c 即値'iはata fistir'c (-即値)'iに翻訳される</a>という設定を過去に作ったが、負値の書式がまだ決まらんので<a href="https://twitter.com/sosoBOTpi/status/904028605277102080">アセンブリ言語としてはnta fistir'c 即値'iを許容することとした</a>。ということでソースコードを編集だ。あと、めんどいので<a href="settings.html#dontuse">現状では負数のリテラルは使用しないことに決めた</a>。</p>

<h2>11. 進捗</h2>
<h3>11-1. part1</h3>
<p>S.YやFafs falira sashimiと<a href="conversations/pointer_and_label.txt">対談</a>して進捗が出た。</p>
<table border="1" cellpadding="5">
<thead><tr><td>旧構文</td><td>新構文</td><td>役割</td></tr></thead>
<tbody><tr><td><u>ラベル名</u><code>:</code></td><td><code>l' </code><u>ラベル名</u>（後ろから修飾）<br><code>nll </code><u>ラベル名</u>（前から修飾）<br></td><td>ラベル名を定義する</td></tr>
<tr><td><code>[</code><u>レジスタ名</u><code>]</code></td><td><u>レジスタ名</u><code>@</code></td><td>レジスタに入っている番地のメモリを表す。</td></tr><tr><td><code>[</code><u>レジスタ名</u><code> + </code><u>定数</u><code>]</code></td><td><u>レジスタ名</u><code> + </code><u>定数</u><code>@</code></td><td>レジスタに入っている番地に定数を足した番地のメモリを表す。</td></tr>
<tr><td><code>[</code><u>レジスタ名</u><code> + </code><u>レジスタ名</u><code>]</code></td><td><u>レジスタ名</u><code> + </code><u>レジスタ名</u><code>@</code></td><td>2つのレジスタに入っている数値を足した番地のメモリを表す。</td></tr>
</tbody></table>
<p>なお、ここで<code>@</code>で転写されている記号はリパライン語では「ioの合字記号」に対応する。Fafs falira sashimiの「<a href="conversations/pointer_and_label.txt">理語的には非文的だけど、アセンブリとしてはできるだけ自然言語に近づいてていい感じな気はする</a>」という発言が決定打となり、採用されることとなった。</p>
<p>ラベル名については、リパライン語に既にあるla lexを使うのが「<a href="conversations/pointer_and_label.txt">エモい</a>」とのことだったので採用することとした。問題はla lexをどう表現するかで、「llxのほうが統一的」という意見が出たものの、統一性がないほうがかえってラベルを追いやすいということで<code>l'</code>が採用された。</p>
<p>なお、la lexは前の文を指すので、x86とは違ってラベルは文の後ろから指定する。となると関数を表すためにラベルを導入したときにラベル定義が関数定義の2行目に出てきてしまいよろしくない。ということで逆向きを表すny la lexも導入することにした。<code>nl'</code>を提案したものの、「ny la lexの詩語での省略形がny l' l'/nyll/であるから<code>nll</code>のほうが想起されやすい」ということなので<code>nll</code>に決まった。</p>

<p>とりあえず<a href="settings.html">設定一覧</a>と<a href="fib_non_recursive.jurli.html">非再帰フィボナッチ</a>と<a href="fib_recursive.jurli.html">再帰フィボナッチ</a>と<a href="./qsort.jurli.html">quicksort</a>を改定。</p>

<h3>11-2. part2</h3>
<p><code>::'c'i</code>を<code>'c'i</code>に改定することにした。ということでサンプルと設定集の修正をした。これで一応確定。あと、インデントが要らない気がしてきたので削除。</p>

<h2>12. 修正</h2>
<h3>12-1. バグ修正</h3>
<p>関数からreturnするときの処理に<a href="https://twitter.com/sosoBOTpi/status/904765453272195072">バグがある</a>ことが発覚した。問題箇所を以下に掲載する。</p>
<div class="box" style="border-color: red">
<p>returnする</p>
<pre>
	'c'i
	krz xx f5@	<span class="comment">; リターンアドレスに飛んで</span>
	ata f5 4	<span class="comment">; スタックからリターンアドレスを削除</span>
</pre>
</div>
<p>問題なのは、<code>krz f5@ xx</code>した時点でリターンアドレスに飛んでいるので、その次の行<code>ata f5 4</code>が実行されず、スタックからリターンアドレスを削除できないことである。</p>
<p>ということで、この際呼び出し規約を変更し、「リターンアドレスの分のスタック掃除も呼び出し側の仕事」という仕様にすることにした。</p>

<p>それに従い、<a href="fib_non_recursive.jurli.html">非再帰フィボナッチ</a>をとりあえず修正した。ついでに手動でウォークスルーを行い、おそらくバグっていないであろうことを確認した。</p>

<p><a href="fib_recursive.jurli.html">再帰フィボナッチ</a>も修正した。しかし、修正最中に、呼び出し規約の新たな変更案が思いついたのである。</p>
<p>現状を見てみよう。</p>
<div class="box">
<p>関数funcを呼び出す</p>
<pre>
	'c'i
	nta f5 4	<span class="comment">; スタックを準備</span>
	inj f5@ xx func	<span class="comment">; リターンアドレスを積んで、同一命令で関数のアドレスにジャンプ</span>
	ata f5 4	<span class="comment">; スタックからリターンアドレスを削除する</span>
</pre>
</div>

<p>この<code>nta f5 4</code>と<code>ata f5 4</code>のペア、無駄では？<code>inj f5-4@ xx func</code>と書きたい。</p>
<p>ただ、まだマイナスがないので改定するにしてもまた今度である。</p>

<p>さて、<a href="./qsort.jurli.html">quicksort</a>も改定した。ウォークスルーはしていないが、多分合っていると信じたい。</p>

<h3>12-2. その他</h3>
<p>スタックの伸長方向はアドレスの減少する向きであることを記載した。この仕様、もともと何も考えずにダイスロールで決めた仕様だったけど、よく考えてみると<code>[f5+20]</code>とかのことを考えるとこっちの方が自然だよなぁ</p>

<h2>13. 課題</h2>
<p><a href="conversations/unambiguously_parsable.txt">現状の仕様だと、ラベル名と命令名が衝突しても弊害が発生しないが、ラベル名とレジスタ名の衝突は起きうる。将来的に命令が増えても互換性は保たれるが、レジスタが増えるとそうはいかなくなる</a>という課題がありますな。さてどうしよう。</p>
<ol>
	<li>バージョン情報を先頭に指定して、それに応じて読み換える</li>
	<li>ラベル名をなんか修飾する（←でも構文もう変えないって宣言したやん）</li>
	<li>初期の段階ではこの問題に気づかないので対処がなされない</li>
</ol>

<p>よし、3で行くか。</p>
<p>冷静に考えると、ラベル名を「参照」するときはともかく、ラベル名を「定義」するときにはレジスタ名と衝突していればエラー検出はできるので、バージョンが上がってもコンパイルできなくなるだけでこっそり挙動が書き換わることはないはず。じゃあええやん（いいとは言っていない）</p>

<p>まあ、これぐらい欠陥があったほうが「黎明期」っぽくてponaだよね。うんうん。黎明期は任意のものがmalbonaなので。<a href="https://en.wikipedia.org/wiki/RANDU">RANDU</a>とか<a href="https://en.wikipedia.org/wiki/Uncontrolled_format_string">printfとその%n</a>とか。</p>

<p>ということで、この課題については「修正しない」という方針で。</p>

<h2>14. パーサー実装</h2>

<p>そろそろインタプリタが欲しくなる今日この頃。Cで書くかHaskellで書くか迷って決められなかったので両方で書いてみる。</p>

<p>とりあえずパーサーは書いた。Haskellでだけだけど。ちゃんと今までに書いた3本も正しく解釈できることがわかった。</p>

<h2>15. マイナス問題の解決</h2>

<p><a href="https://www.amazon.co.jp/dp/4798044784">ハロー“Hello,World"OSと標準ライブラリのシゴトとしくみ</a>を読んだところ、<code>[ESP-4]</code>を実現するためにx86は普通に0xfffffffcを足していた。ということで4294967292を足せばいいでしょう。やったぜ。</p>

<p>ということで呼び出し規約改定しまーす。リターンアドレスはf5-4に積まれる設定にします。</p>

<p>とりあえず<a href="fib_non_recursive.jurli.html">非再帰フィボナッチ</a>と<a href="fib_recursive.jurli.html">再帰フィボナッチ</a>を修正。さらに<a href="./qsort.jurli.html">quicksort</a>も直した。なんかスタックバグってた気がしたのでウォークスルーした。なお設定に凡ミス（f5は第一引数ではなく最終引数）があったので直した。</p>

<h2>16. インタプリタについて</h2>

<h3>16-1. メモリの仕様</h3>

<p>インタプリタは関数を実行するという形式にしたい。じゃあそのリターンアドレスってどうしようか。乱数に聞いたら0xbda574b8という答えを返してきたのでそうしよう。えーと10進数だと…3181737144かなるほど。スタックポインタの位置はどうしよう。これまた乱数でいいか。0x6d7aa0f8、つまり1836753144か。</p>

<p>ということで、インタプリタは、例えば3変数関数なら、以下の条件で関数を実行することになる。</p>

<div class="box">
<p>レジスタ</p>
<table>
<thead>
<tr><td>レジスタ名</td><td>内容</td></tr>
</thead>
<tbody>
<tr><td>f0</td><td>なんか</td></tr>
<tr><td>f1</td><td>なんか</td></tr>
<tr><td>f2</td><td>なんか</td></tr>
<tr><td>f3</td><td>なんか</td></tr>
<tr><td>f5</td><td>1836753144</td></tr>
</tbody>
</table>
<p>メモリ</p>
<table>
<thead>
<tr><td>番地</td><td>内容</td></tr>
</thead>
<tbody>
<tr><td>1836753140</td><td>3181737144</td></tr>
<tr><td>1836753144</td><td>第三引数</td></tr>
<tr><td>1836753148</td><td>第二引数</td></tr>
<tr><td>1836753152</td><td>第一引数</td></tr>
<tr><td>1836753156</td><td>なんか</td></tr>
</tbody>
</table>
</div>

<p>文字列へのポインタとかを渡したいし、（ダイスロール、aか）0xa0000000 ~ 0xafffffffのメモリの内容は自由に関数がいじっていいことにしよう。28bitのアドレス空間ってことは256MBか。でかいな。まあいいか。インタプリタだし関数書く側が節度を持ってメモリを使えばいい。</p>

<p>さて、メモリにデータをセットするのはどうやって行おう。あ、そうか、テストしたい関数を呼び出す関数を別に作って、mainではメモリにデータを書き込めばいいのかそれはそうか。</p>

<p>思い出したので書いておくと、2003'd ferlesylでは<code>3181737144@</code>とは書けない。だって即値で書くことなんてあんまないやん。即値でアドレス指定して書き込みたいなら普通に<code>krz 3181737144 f0 krz 123 f0@</code>と書けば十分だし。</p>

<p>話を戻して、ラップ関数を作るんならmain関数はゼロ引数でいいでしょう。その方が楽だ。ということで改訂。</p>

<div class="box">
<p>レジスタ</p>
<table>
<thead>
<tr><td>レジスタ名</td><td>内容</td></tr>
</thead>
<tbody>
<tr><td>f0</td><td>なんか</td></tr>
<tr><td>f1</td><td>なんか</td></tr>
<tr><td>f2</td><td>なんか</td></tr>
<tr><td>f3</td><td>なんか</td></tr>
<tr><td>f5</td><td>1836753144</td></tr>
</tbody>
</table>
<p>メモリ</p>
<table>
<thead>
<tr><td>番地</td><td>内容</td></tr>
</thead>
<tbody>
<tr><td>1836753132</td><td>なんか</td></tr>
<tr><td>1836753136</td><td>なんか</td></tr>
<tr><td>1836753140</td><td>3181737144</td></tr>
<tr><td>1836753144</td><td>なんか</td></tr>
<tr><td>1836753148</td><td>なんか</td></tr>
<tr><td>1836753152</td><td>なんか</td></tr>
<tr><td>1836753156</td><td>なんか</td></tr>
</tbody>
</table>
</div>

<h2>17. やっぱ直す</h2>

<p>4294967292は流石にクソでしょ。revertします。</p>
<p>それに応じてインタプリタのメモリ構成も修正。</p>

<div class="box">
<p>レジスタ</p>
<table>
<thead>
<tr><td>レジスタ名</td><td>内容</td></tr>
</thead>
<tbody>
<tr><td>f0</td><td>なんか</td></tr>
<tr><td>f1</td><td>なんか</td></tr>
<tr><td>f2</td><td>なんか</td></tr>
<tr><td>f3</td><td>なんか</td></tr>
<tr><td>f5</td><td>1836753144</td></tr>
</tbody>
</table>
<p>メモリ</p>
<table>
<thead>
<tr><td>番地</td><td>内容</td></tr>
</thead>
<tbody>
<tr><td>1836753132</td><td>なんか</td></tr>
<tr><td>1836753136</td><td>なんか</td></tr>
<tr><td>1836753140</td><td>なんか</td></tr>
<tr><td>1836753144</td><td>3181737144</td></tr>
<tr><td>1836753148</td><td>なんか</td></tr>
<tr><td>1836753152</td><td>なんか</td></tr>
<tr><td>1836753156</td><td>なんか</td></tr>
</tbody>
</table>
</div>

<p>はいオーケー。ファイクレオネは救われた。万歳万歳。</p>

<h2>18. インタプリタについてpart2</h2>
<h3>18-1. メモリの仕様part2</h3>

<p>とりあえずHaskellでメモリを実装。内部構造は<code>Data.Map.Map Word32 Word32</code>で、空メモリと書き込みと読み込みのみを実装。書き込まれていないところから読み込んだ場合、アドレスをシード値とした擬似乱数を返し、さらにそのアクセスを記録する（意図しない値の読み込みはバグなので）。</p>

<p>さて、nxとxxはどうしよう。本来ならopcodeが決まっているのでnxとxxが定義できるはずなのだが、まだ決まっていないのである。</p>

<p>さてさて、そんなことより深刻なバグに気づいた。普通に各アドレスに4byte振ってた。ダメやん。ということで4の倍数のアドレス以外にアクセスした時の処理を考えねば。問題はエンディアンをどうするか。（ダイスロール）ビッグエンディアンで載せよう。</p>

<p>しかし、2003'd ferlesylは基本的に32bitなのに、単一のアドレスの記憶容量はなぜbyte単位なのだろう？まあ、「既存の組み込みOSで使われていたメモリを再利用したかったため」でいいか。CPUはともかくメモリの仕様は変えたくないだろうし。</p>

<p>まあ、わざわざアドレスが振ってあるってことはアドレス単位の書き込みもしたくなるよなぁ。とはいえ必要になった時に考えればいいとは思うが。</p>

<p>とりあえず、<code>Data.Map.Map Word32 Word8</code>に変更する。んで普通は4byte読み出す。</p>

<h3>18-2. nxとxx</h3>

<p>【再掲】さて、nxとxxはどうしよう。本来ならopcodeが決まっているのでnxとxxが定義できるはずなのだが、まだ決まっていないのである。</p>

<p>えーと、「『次の命令を指すところにxxを移動させる→nxの指す命令を実行する→xxの指す位置にnxを動かす』を繰り返す」という挙動である。しかし今は『次の命令』が分からんのでなぁ、という。</p>

<p>とりあえず、思いついた案。Haskellで<code>Data.Map.Map Word32 (Word32, Instruction)</code>と<code>Data.Map.Map Label Word32</code>を用意して、第一mapのvalueのfstが『次の命令』、とすればよかろう。</p>

<div class="box">
<p>第一map</p>
<table>
<thead>
<tr><td>k</td><td>value's fst</td><td>value's snd</td></tr>
</thead>
<tbody>
<tr><td>1234</td><td>1236</td><td>Krz (L (RPlusNum F5 4)) (Re F0)</td></tr>
<tr><td>1236</td><td>1239</td><td>Krz (Pure 0) (Re F1)</td></tr>
<tr><td>1239</td><td>1242</td><td>Krz (Pure 1) (Re F2)</td></tr>
<tr><td>1242</td><td>1244</td><td>Fi (L (Re F0)) (Pure 0) Clo</td></tr>
<tr><td>1244</td><td>1245</td><td>MalKrz (Lab "ka") (Re XX)</td></tr>
<tr><td>1245</td><td>1246</td><td>Nta (Pure 1) (Re F0)</td></tr>
<tr><td>1246</td><td>1247</td><td>Krz (L (Re F1)) (Re F3)</td></tr>
</tbody>
</table>
<p>第二map</p>
<table>
<thead>
<tr><td>k</td><td>value</td></tr>
</thead>
<tbody>
<tr><td>Lab "is"</td><td>1242</td></tr>
</tbody>
</table>
</div>

<p>さて、この2つのmapのペアに何ていう名前をつけようか。tentative loadでいいか。乱数で決めた適当なオペランド長のもとでロードするという。</p>

<p>とりあえず実装した。</p>

<h3>18-3. インタプリタ</h3>
<p>気がついたらインタプリタが実装し終わっていた。さて実行してみよう。おお、<a href="https://twitter.com/sosoBOTpi/status/907548903360274432">fib 12</a>がちゃんと144を返すではないか。</p>

<textarea readonly cols="80" rows="10" style="font-family: monospace;">
*Main> fullExecute program
(CPU {f0 = 144, f1 = 144, f2 = 233, f3 = 233, f5 = 1836753144, nx = 3181737144, xx = 3181737144, flag = True},Memory {unM = fromList [(1836753136,20),(1836753137,130),(1836753138,232),(1836753139,221),(1836753140,0),(1836753141,0),(1836753142,0),(1836753143,12),(1836753144,189),(1836753145,165),(1836753146,116),(1836753147,184)], garbages = [(1836753143,11),(1836753142,189),(1836753141,111),(1836753140,33)]})</textarea>

<textarea readonly cols="80" rows="40" style="font-family: monospace;">*Main> fullExecute program2
(CPU {f0 = 144, f1 = 0, f2 = 89, f3 = 2462086118, f5 = 1836753144, nx = 3181737144, xx = 3181737144, flag = True},Memory {unM = fromList [(1836753044,20),(1836753045,130),(1836753046,233),(1836753047,13),(1836753048,20),(1836753049,130),(1836753050,233),(1836753051,13),(1836753052,20),(1836753053,130),(1836753054,233),(1836753055,13),(1836753056,20),(1836753057,130),(1836753058,233),(1836753059,13),(1836753060,20),(1836753061,130),(1836753062,233),(1836753063,13),(1836753064,20),(1836753065,130),(1836753066,233),(1836753067,13),(1836753068,0),(1836753069,0),(1836753070,0),(1836753071,0),(1836753072,0),(1836753073,0),(1836753074,0),(1836753075,1),(1836753076,20),(1836753077,130),(1836753078,233),(1836753079,13),(1836753080,0),(1836753081,0),(1836753082,0),(1836753083,2),(1836753084,0),(1836753085,0),(1836753086,0),(1836753087,2),(1836753088,20),(1836753089,130),(1836753090,233),(1836753091,13),(1836753092,0),(1836753093,0),(1836753094,0),(1836753095,4),(1836753096,0),(1836753097,0),(1836753098,0),(1836753099,5),(1836753100,20),(1836753101,130),(1836753102,233),(1836753103,13),(1836753104,0),(1836753105,0),(1836753106,0),(1836753107,6),(1836753108,0),(1836753109,0),(1836753110,0),(1836753111,13),(1836753112,20),(1836753113,130),(1836753114,233),(1836753115,13),(1836753116,0),(1836753117,0),(1836753118,0),(1836753119,8),(1836753120,0),(1836753121,0),(1836753122,0),(1836753123,34),(1836753124,20),(1836753125,130),(1836753126,233),(1836753127,13),(1836753128,0),(1836753129,0),(1836753130,0),(1836753131,10),(1836753132,0),(1836753133,0),(1836753134,0),(1836753135,89),(1836753136,20),(1836753137,130),(1836753138,232),(1836753139,221),(1836753140,0),(1836753141,0),(1836753142,0),(1836753143,12),(1836753144,189),(1836753145,165),(1836753146,116),(1836753147,184)], garbages = [(1836753055,59),(1836753054,237),(1836753053,159),(1836753052,81),(1836753063,171),(1836753062,93),(1836753061,15),(1836753060,193),(1836753071,27),(1836753070,205),(1836753069,127),(1836753068,49),(1836753079,139),(1836753078,61),(1836753077,239),(1836753076,161),(1836753087,251),(1836753086,173),(1836753085,95),(1836753084,17),(1836753095,107),(1836753094,29),(1836753093,207),(1836753092,129),(1836753103,219),(1836753102,141),(1836753101,63),(1836753100,241),(1836753111,75),(1836753110,253),(1836753109,175),(1836753108,97),(1836753119,187),(1836753118,109),(1836753117,31),(1836753116,209),(1836753127,43),(1836753126,221),(1836753125,143),(1836753124,65),(1836753135,155),(1836753134,77),(1836753133,255),(1836753132,177),(1836753143,11),(1836753142,189),(1836753141,111),(1836753140,33)]})</textarea>

<p>ん？しかし<a href="https://twitter.com/sosoBOTpi/status/907550774707634177">garbagesの欄があるのが奇妙だ</a>。初期化されていないメモリを読んだ時にのみこういうことは起きるはずなのだが。アドレスを見る限りf5周りのようだ。</p>

<p><a href="https://twitter.com/sosoBOTpi/status/907567223962615808">原因究明に成功</a>。<code>krz</code>をHaskellのconst関数で実装していたので、メモリから「読んで」それを捨てる、という実装になってしまっていた。なるほど。</p>

<h2>19. 諸々</h2>
<p>インタプリタでは既に実装してあるので、'i'cを仕様にした。</p>

<p>クイックソート、バグってるつらい。</p>
<div class="box">
<p>とりあえずinjによるswapは問題ないことが確認できた</p>
<textarea readonly cols="80" rows="8" style="font-family: monospace;">
*Main> fullExecute "'c'i  krz f1 0  krz f1@ 123 krz f1+4@ 456 inj f1@ f1+4@ f1@  'c'i krz xx f5@"
(CPU {f0 = 2196503685, f1 = 0, f2 = 2633517981, f3 = 2462086118, f5 = 1836753144, nx = 3181737144, xx = 3181737144, flag = False},Memory {unM = fromList [(0,0),(1,0),(2,1),(3,200),(4,0),(5,0),(6,0),(7,123),(1836753144,189),(1836753145,165),(1836753146,116),(1836753147,184)], garbages = []})
</textarea>
</div>
<p>原因判明。直したスタックバグが0xfffffffcのrevertで復活してただけだった。実行してみる。</p>

<div class="box">
<p>つらい</p>
<textarea readonly cols="80" rows="16" style="font-family: monospace;">
*Main> fullExecute program3
(CPU {f0 = 2782070968, f1 = 14, f2 = 14, f3 = 15, f5 = 1836753144, nx = 3181737144, xx = 3181737144, flag = True},Memory {unM = fromList [(1836752928,20),(1836752929,130),(1836752930,233),(1836752931,143),(1836752932,0),(1836752933,0),(1836752934,0),(1836752935,14),(1836752936,0),(1836752937,0),(1836752938,0),(1836752939,14),(1836752940,165),(1836752941,211),(1836752942,8),(1836752943,184),(1836752944,0),(1836752945,0),(1836752946,0),(1836752947,13),(1836752948,20),(1836752949,130),(1836752950,233),(1836752951,143),(1836752952,0),(1836752953,0),(1836752954,0),(1836752955,14),(1836752956,0),(1836752957,0),(1836752958,0),(1836752959,13),(1836752960,165),(1836752961,211),(1836752962,8),(1836752963,184),(1836752964,0),(1836752965,0),(1836752966,0),(1836752967,12),(1836752968,20),(1836752969,130),(1836752970,233),(1836752971,143),(1836752972,0),(1836752973,0),(1836752974,0),(1836752975,14),(1836752976,0),(1836752977,0),(1836752978,0),(1836752979,12),(1836752980,165),(1836752981,211),(1836752982,8),(1836752983,184),(1836752984,0),(1836752985,0),(1836752986,0),(1836752987,11),(1836752988,20),(1836752989,130),(1836752990,233),(1836752991,143),(1836752992,0),(1836752993,0),(1836752994,0),(1836752995,14),(1836752996,0),(1836752997,0),(1836752998,0),(1836752999,11),(1836753000,165),(1836753001,211),(1836753002,8),(1836753003,184),(1836753004,0),(1836753005,0),(1836753006,0),(1836753007,10),(1836753008,20),(1836753009,130),(1836753010,233),(1836753011,143),(1836753012,0),(1836753013,0),(1836753014,0),(1836753015,14),(1836753016,0),(1836753017,0),(1836753018,0),(1836753019,9),(1836753020,165),(1836753021,211),(1836753022,8),(1836753023,184),(1836753024,0),(1836753025,0),(1836753026,0),(1836753027,8),(1836753028,20),(1836753029,130),(1836753030,233),(1836753031,143),(1836753032,0),(1836753033,0),(1836753034,0),(1836753035,14),(1836753036,0),(1836753037,0),(1836753038,0),(1836753039,8),(1836753040,165),(1836753041,211),(1836753042,8),(1836753043,184),(1836753044,0),(1836753045,0),(1836753046,0),(1836753047,7),(1836753048,20),(1836753049,130),(1836753050,233),(1836753051,143),(1836753052,0),(1836753053,0),(1836753054,0),(1836753055,14),(1836753056,0),(1836753057,0),(1836753058,0),(1836753059,6),(1836753060,165),(1836753061,211),(1836753062,8),(1836753063,184),(1836753064,0),(1836753065,0),(1836753066,0),(1836753067,5),(1836753068,20),(1836753069,130),(1836753070,233),(1836753071,143),(1836753072,0),(1836753073,0),(1836753074,0),(1836753075,14),(1836753076,0),(1836753077,0),(1836753078,0),(1836753079,5),(1836753080,165),(1836753081,211),(1836753082,8),(1836753083,184),(1836753084,0),(1836753085,0),(1836753086,0),(1836753087,4),(1836753088,20),(1836753089,130),(1836753090,233),(1836753091,143),(1836753092,0),(1836753093,0),(1836753094,0),(1836753095,14),(1836753096,0),(1836753097,0),(1836753098,0),(1836753099,3),(1836753100,165),(1836753101,211),(1836753102,8),(1836753103,184),(1836753104,0),(1836753105,0),(1836753106,0),(1836753107,2),(1836753108,20),(1836753109,130),(1836753110,233),(1836753111,143),(1836753112,0),(1836753113,0),(1836753114,0),(1836753115,14),(1836753116,0),(1836753117,0),(1836753118,0),(1836753119,2),(1836753120,165),(1836753121,211),(1836753122,8),(1836753123,184),(1836753124,0),(1836753125,0),(1836753126,0),(1836753127,1),(1836753128,20),(1836753129,130),(1836753130,233),(1836753131,52),(1836753132,0),(1836753133,0),(1836753134,0),(1836753135,14),(1836753136,0),(1836753137,0),(1836753138,0),(1836753139,0),(1836753140,165),(1836753141,211),(1836753142,8),(1836753143,184),(1836753144,189),(1836753145,165),(1836753146,116),(1836753147,184),(2782070968,0),(2782070969,0),(2782070970,0),(2782070971,0),(2782070972,0),(2782070973,0),(2782070974,0),(2782070975,0),(2782070976,0),(2782070977,0),(2782070978,0),(2782070979,0),(2782070980,0),(2782070981,0),(2782070982,0),(2782070983,0),(2782070984,0),(2782070985,0),(2782070986,0),(2782070987,5),(2782070988,0),(2782070989,0),(2782070990,0),(2782070991,9),(2782070992,0),(2782070993,0),(2782070994,0),(2782070995,2),(2782070996,0),(2782070997,0),(2782070998,0),(2782070999,6),(2782071000,0),(2782071001,0),(2782071002,0),(2782071003,5),(2782071004,0),(2782071005,0),(2782071006,0),(2782071007,3),(2782071008,0),(2782071009,0),(2782071010,0),(2782071011,5),(2782071012,0),(2782071013,0),(2782071014,0),(2782071015,8),(2782071016,0),(2782071017,0),(2782071018,0),(2782071019,9),(2782071020,0),(2782071021,0),(2782071022,0),(2782071023,7),(2782071024,0),(2782071025,0),(2782071026,0),(2782071027,9)], garbages = []})

</textarea>
</div>

<p><a href="https://twitter.com/sosoBOTpi/status/907744430941073409">原因判明。p[a]はp+a番地じゃなくてp+4a番地だ</a>。とはいえ掛け算とかまだ仕様を固めていないので、とりあえずビットシフトを実装。</p>

<p>しかしやっぱり直らない。もう諦めるか。とりあえずたらい関数でも実装しよう。</p>
<p>動かない。悲しいなぁ</p>
<p>とりあえずファイルから読み込めるように。</p>

<p>再帰フィボナッチとかいじってたら、アルゴリズムが改良できただけでなく、新たなコーディング規約的なものを思いつくことにも成功した。改行不要であることがうまく効いてくる</p>
<div class="box">
<pre>
'c'i    
nta f5 4   krz f5@ 12
nta f5 4   inj f5@ xx fib2   ata f5 8
krz xx f5@

'c'i
nll fib2
krz f0 f5+4@
fi f0 2 xylo   malkrz xx iska
krz f1 f0
nta f1 1

nta f5 4   krz f5@ f1
nta f5 4   inj f5@ xx fib2  ata f5 4

inj f1 f5@ f0  
nta f1 1 

nta f5 4  krz f5@ f1  
nta f5 4  inj f5@ xx fib2  ata f5 8
 
ata f0 f5@  

ata f5 4 
krz xx f5@
l' iska
</pre>
</div>

<p>たらい関数の不可解なバグの原因が判明。<a href="https://twitter.com/sosoBOTpi/status/907799715369988097">nta 4 f5の書き忘れ</a>。しかしそれを直したところでx>yのときには動かないのである。悲しいなぁ。</p>

<p>色々いじくりまわして原因が判明。<a href="https://twitter.com/sosoBOTpi/status/907864962285969408">-1がunsignedだから4294967295になって無限ループ</a>。<a href="https://twitter.com/sosoBOTpi/status/907869241143001089">比較の時だけはsignedとunsigned両方作らなきゃいけないのを一回意識したことがあったけどその後忘れてしまっていた。</a></p>

<h2>20. 比較指定子の改良</h2>
<p>ということで、比較指定子を改良しなきゃですな。</p>
<p>話した結果、今までの比較指定子はsigned用に使うことにして、<a href="https://jurliyuuri.slack.com/archives/C698QT6DQ/p1505288787000085">unsignedな比較は比較指定子の後ろにnys（ny snakxazで「非負の」の略）をくっつけることにした</a>。あと、<a href="https://jurliyuuri.slack.com/archives/C6Q71RE4V/p1505210415000149">fi f1 f2 niv</a>で<code>!=</code>を表すのが<a href="https://jurliyuuri.slack.com/archives/C6Q71RE4V/p1505287317000073">採用された</a>。ということで書いていきましょう</p>
<p>実装完了。さてたらいだ。<a href="https://twitter.com/sosoBOTpi/status/907884484703293440">動いた！やった！</a></p>

<p>あと、なぜか知らんが<a href="https://twitter.com/sosoBOTpi/status/907975150364123136">クイックソートが直っていた</a>。なぜだろう。まあいいや。</p>

<p>とりあえずソースコードを整形して…っと、入力例としてはπよりτを使うべきだな。修正しよう。ソースコードを整形し、htmlの方にもそれを反映。</p>

<h2>21. 次のステップ</h2>
<p>次にすべきこととして、候補は</p>
<ul>
<li>乗算・除算の実装
<ul><li>64bitの演算を補助する機構を作らなきゃね</li></ul>
</li>
<li>ドキュメントの整備
<ul><li>インタプリタの仕様とアセンブリ言語の仕様をきちんと分離しなきゃね</li></ul></li>
<li>デバッグ環境の整備
<ul><li>外部関数の呼び出しとして実装するから、そっち方面の言語仕様の拡充にも繋がるよ</li></ul></li>
</ul>
</ul>
<p>の3通りぐらいある。迷ったので<a href="https://twitter.com/sosoBOTpi/status/908266709655490560">アンケートをとった</a>ところ、デバッグ環境の整備50%、乗算・除算の実装25%、ドキュメントの整備25%となった。ということで、まずはデバッグ環境と外部関数呼び出しですな</p>

<p><a href="https://twitter.com/hsjoihs/status/908451769545408512">無事ホテルに着いた</a>のでやっていきましょう。</p>

<p>そういえば、除算ってそういえばゼロ割問題もあるやん（あるやん）</p>

<h2>22. デバッグ環境と外部関数</h2>
<h3>22-1. 組み込み関数とアドレスの現状</h3>
<p><a href="https://twitter.com/sosoBOTpi/status/908556126832156673">とりあえず、</a></p>
<ul>
	<li>ステップ実行</li>
	<li>もうちょい読みやすいメモリダンプ</li>
	<li>うるさく口出ししてくれるwarning機能</li>
	<li>呼ぶと色々な情報を吐いてくれる組み込み関数</li>
</ul>
<p>をやっていきましょう。さて何から作ろうかな。組み込み関数でも作るか。</p>
<p>現状、「0xbda574b8に飛んだときに明示的にTERMINATEする」という一種の組み込み関数があるわけだ。さて組み込み関数にはどこのアドレスを割り当てようか。とりあえず現状で使っているアドレスの一覧をば</p>
<div class="box" style="font-family: monospace;">


	<table>
		<tr><td>アドレス</td><td>役割</td>
		<tr><td>0x1482e8d4</td><td>プログラムがロードされる位置</td></tr>
		<tr><td>0x6d7aa0f8</td><td>スタックポインタの初期位置</td></tr>
		<tr><td>0xa0000000 - 0xaffffffc</td><td>自由に関数がいじっていい領域</td></tr>
		<tr><td>0xbda574b8</td><td>ここにreturnすると処理が正常終了する</td></tr>
	</table>		
</div>
<p>ふむふむ。じゃあとりあえず0xbdaqqqqqあたりに組み込み関数とかは配置することにしておきましょうかね。まあ単純にラベルとして定義しておいてジャンプしたときにインタプリタが特別に扱えば良い。</p>

<h3>22-2. 用語の整理</h3>
<p><a href="https://twitter.com/Vane11ope/status/908561109744893956">ステップ実行ともうちょい読みやすいメモリダンプ</a>の方が欲しいと言われた。なるほど。</p>
<p>ステップ実行するからにはinteractiveなプログラムにしなきゃいけないが、さてさてinteractiveってどう訳そうか。</p>
<p>聞いたら<a href="https://twitter.com/sashimiwiki/status/908572537109356545">xarzni'arプログラム</a>というのを提案された。<a href="https://twitter.com/sashimiwiki/status/908573053218562048">宗教的なカウンセラー</a>だそうだ。めっちゃええやん。<span style="font-size: 80%;">現世の情報界隈って宗教的な諸々がほぼ採用されていない（だからこそ「宗教」という語が「vim vs. Emacs」「2-space vs. 4-space indent」とかのことを指せる）ので、対比としても面白いよね</span></p>
<p>ということで、用語集に追加して、さらに用語集へのリンクをこのページにも貼った。</p>

<h3>22-3. コメント</h3>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">とはいえ現実世界に住まいしものが少しずつ悠里OSに馴染むための過渡期において、コードにコメントが書けるのは相当急務な気もしてきた。むしろ最初は一行一行にコメント残したい。レジスタの値とかではなくそもそも、xoloってなんだっけ？とか言っていちいちドキュメントに戻る手間が省ける。</p>&mdash; ゔぁねろぺ (@Vane11ope) <a href="https://twitter.com/Vane11ope/status/908583527926480896">2017年9月15日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>ということで、<a href="https://twitter.com/sosoBOTpi/status/908583834962223109">現世での独自拡張として</a>セミコロンでのコメントアウト機能を<a href="https://twitter.com/sosoBOTpi/status/908584985329754112">5分で</a>実装した。</p>

<h3>22-4. メモリダンプの改良</h3>
<p>メモリダンプを改良していきましょう。とりあえず印字用の関数をね</p>

<p>まず、<code>Data.Map.Map Word32 Word8</code>を<code>Data.Map.Map Word32 (Maybe Word32)</code>に変換する関数を作成。</p>
<p>そしてそれをShowに繋ぐと、<a href="https://twitter.com/sosoBOTpi/status/908816485421801472">圧倒的に読みやすくなった</a>。</p>

<h3>22-5. ステップ実行</h3>
<p>さて、インタラクティブな…じゃなかった、<a href="https://twitter.com/sashimiwiki/status/908575787875315712">xarzni'arvenな</a>やつを実装していきましょう。さてコマンドライン引数どうしようか。<a href="https://twitter.com/sosoBOTpi/status/908568221933961216">[]~&lt;&gt;@$&amp;\_</a>が使えるそうだ。</p>
<p>まあいいや。とりあえず<code>-x</code>でええやろ。現世対応のために<code>-I</code>も許容するか。</p>

<h3>22-6. 進捗ダメです</h3>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">インタラクティブなインタプリタとそうでないインタプリタを分離すべきかどうかという問題</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/908833734773825536">2017年9月15日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">これで迷っていて2時間ぐらい進捗がない顔をしている <a href="https://t.co/Z1jTGiJaAx">https://t.co/Z1jTGiJaAx</a></p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/908861431134613504">2017年9月16日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">これで迷っていて4時間半ぐらい進捗がない顔をしている <a href="https://t.co/bGWFUwnBpP">https://t.co/bGWFUwnBpP</a></p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/908899983193137153">2017年9月16日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>進捗ダメです。</p>

<h3>22-7. Q&amp;A</h3>
<p>Ritchanさん (<a href="https://twitter.com/aios_ciao">@aios_ciao</a>)から質問が結構来たので<a href="https://togetter.com/li/1151279">Togetter</a>にまとめた。ありがたい。後で仕様書書く時に役立てよう。</p>


<h3>22-8. 進捗出します</h3>
<p>とりあえず<code>-x</code>オプションを追加。</p>
<p>さて、今無限再帰しているのを1個ずつ実行していきたいと。なんかこういうのって不動点コンビネータとかいうの使うと綺麗に書けるんじゃなかったっけ。知らんけど。</p>

<p>書けた。なるほど、不動点コンビネータってこうやって使うのね</p>

<p>さて、型パズルの時間だ。何をどうすればいい？とりあえず、「<code>-x</code>オプションで起動、コマンドでファイルを読み込んでそれをステップ実行」と「<code>-x</code>オプションをつけてファイルパスを指定した状態で起動、それをステップ実行」の2択か。まあロードコマンド作るのがめんどいので後者で。ファイルが提供されていなかったらstderrにメッセージ吐いて終了。</p>

<p>さて、どうすればいいか。ファイルを読んでロードした時点で<code>toTentativeLoad</code>しているから<code>TentativeLoad</code>型の値を持っている。</p>

<p>モナドの連鎖を理解するのが難しいので、ラッパを剥がすだけの関数unwrapWithを定義。これは<code>(Hardware, TentativeLoad) -> VIO a -> (Either Error Hardware, Logs)</code>という型を持っている。</p>
<p>えーと、<code>execOne (return ())</code>して、<code>Hardware</code>を回収して、あれ<code>Logs</code>を送り込む方法がないぞ。あ、そうか、先頭でtellとかしてやらなきゃいかんのか</p>
<p>んーでもこれ仕様でよくない？ステップ実行なんだから前に書いたログはもう一回書かれない方がいいだろ</p>

<p>さて、次の問題としては、<code>TERMINATE</code>したのかどうかを判別する方法。現状だとともに<code>return ()</code>なんよね</p>

<p>まあBoolを返すようにすればいいか。<code>True</code>ならステップ実行を継続、<code>False</code>なら完全終了。</p>

<p>とりあえずExecute.hs側だけ変えると…あれ、型エラーが起きない。なるほど、もともと<code>()</code>だったやつを握りつぶしているからか。</p>

<p>ということでそれをちゃんと返すようにして、fullExecuteの方もいじる。</p>

<p>あとは諸々をやって、完成。多分。途中でフラグの意味逆にしてバグったけど。</p>


<h3>22-9. 組み込み関数</h3>

<p>あとは組み込み関数を作ればなんとかなるやろ。何が欲しいかなぁ</p>
<ul>
	<li>ログに数値を吐く</li>
	<li>メモリを確保する</li>
</ul>
<p>こんなもんかなぁ。とりあえずログから実装するか。関数名どうしよう。「出力する」がeinesらしいのでそれでいいか。</p>
<p>さて、アセンブリ言語としては「外部の関数<code>eines</code>の存在」を教えてもらわなきゃいかんよな。Cでいうヘッダファイルを読み込んでプロトタイプ宣言を受け取るみたいな。コンパイラの実装としては標準ライブラリとリンクするみたいな事だと思うけど、インタプリタの場合は単にエミュレート。</p>

<p>さて「外部の関数」ってどう言おう。xokisonが「別の場所で」らしいからそれでいいか。</p>
<p>予約語的なの整理しなきゃだよなぁ、ちょっくらドキュメントいじるか</p>

<h2>23. ドキュメントいじり</h2>	

<p>ちょびっといじった。</p>	

<h2>24. 外部関数</h2>	
<p>ラベルに使える文字列を決めていなかったなぁ。ちょうどこの前<code>String</code>型と<code>Label</code>型を分離したことだし、ちょっと考えておくか。</p>
<p>リパーシェ相当はいいとして、数字、あとアポストロフィ、ハイフンも許容しようかなぁ。アンダーバーも許容するか。</p>

<p>とりあえず、コンストラクタを隠すことでラベルのチェックを徹底するようにした。<code>fullParse "nll 123$$$ fen"</code>を落とすようにした。</p>

<p>リパーシェ相当は…<code>pFftcxkqhRzmnrljwbVvdsgXiyuoea</code>か。数字は<code>0123456789</code>で、アポストロフィ<code>'</code>とハイフン<code>-</code>とアンダーバー<code>_</code>を許せばええやろ</p>

<p>ということで<code>isAlphaNum</code>を変更します</p>

<p>そしてそれを<a href="settings.html">settings.html</a>の方にも書いた。ついでに+と@の前後のスペースは任意であることも書いた。</p>

<h2>25. 開平法とデバッグ</h2>
<h3>25-1. 開平法</h3>
<p>開平法を書こう。ライブラリとして使えそうだし。</p>
<p>ラベルにFとfを両方使ったらバグった。なるほど、toLowerのせいか。直さねば。</p>
<p>そして、同一のラベルが複数あったらエラーにしなきゃいけないのを忘れていたことにも気づいた。</p>
<p>さて、一時しのぎにラベル名を<code>c</code>にしたがまだ動かない。なぜだ。</p>
<p>原因判明。<code>xylonys</code>を<code>xylo</code>と書いていた。直したら動いた。</p>

<p>とりあえず<a href="lakormeru.jurli.html">HTMLにして</a>リンクを掲載。</p>

<h3>25-2. デバッグ</h3>

<p>とりあえず<code>toLower</code>を排除した。これで第一の問題は解決。</p>
<p>次に、複数ラベルの検出をせねば。とりあえずモナディックにしよう。</p>
<p>弾いた。これで<code>nll a   fen   nll a   fen   nll b   fen   fen   l' b</code>がエラーになる。</p>

<h2>26. 会話による進捗</h2>
<h3 id="i26_1">26-1. 「ライブラリ」をどう訳す？</h3>
<p><a href="conversations/library.txt">ライブラリをリパライン語でどう呼ぶかについて話し合った</a>。また、<a href="conversations/library2.txt">パイグ語の方に関しても話し合った</a>。そしてその結果を<a href="https://sites.google.com/site/panqateel/yougo">用語集に書いた</a>。</p>

<p>「レシピ本」という提案がFixa.siertija（れもん氏、<a href="https://twitter.com/_lem0n_">@_lem0n_</a>）から出たので、「料理の本」ということでjujojel'd akrantierlとした。ただ、長いので当然略されるだろうという話になり、Fafs.faliraが「juakとか音節を取ったり、頭字語としてJAとか、それを文字化してjera」という提案をした。j.vの「juak、パイグ人が好きそう」という発言とFafs.faliraの「リパラオネ人としてはjera」という発言により、「リパライン語ではjeraと呼ばれるが、パイグ語ではjuakと略されており（発音は/juak/または/yak/）、パイグ人エンジニアの多くはこの略称がリパラオネ人にも通じると思い込んでいる」という設定になった。日本語の「CUI」みたいな立ち位置である。</p>

<h3>26-2. tkcバイナリの位置付け</h3>
<p><a href="conversations/architecture.txt">いわゆるtkcバイナリについて話し合った。</a>決定したことを以下に書いていく。なお、panqateelで使われるバイナリのことを便宜上j.vバイナリと仮称するが、この呼び方は真理設定ではない。</p>

<table>
	<thead>
		<tr><td style="width: 170px;">決定事項</td><td>歴史設定</td></tr>
	</thead>
	<tbody>
		<tr><td>tkcバイナリは固定長<br>j.vバイナリは可変長</td><td>黎明期の一般向けの商用コンピュータではメモリの使用量が抑えられる可変長が採用されたが、固定長の方が実行速度が稼ぎやすかった<span style="font-size:80%">（『nxの次の命令を指すところにxxを移動させる』という処理にメモリアクセスが不要になること、必ず4byte単位になるためアラインメントが楽になることなどが挙げられる）</span>ので、tkcバイナリが後に設計され科学技術計算などのために使われた。</td></tr>
		<tr><td>同一のアセンブリ言語が、異なるアセンブラによって翻訳されることでtkcバイナリとj.vバイナリとに分かれる</td><td>tkcバイナリのシェアはそれほど高くないので、tkcバイナリ用に一から高級言語のコンパイラを作るのも手間であったし、j.vバイナリ用にビルドされたプログラムが利用できないと不便である。よって、アセンブリ言語レベルの互換にすることで、<span style="font-size:80%">（アーキテクチャ設計の自由度は下がるものの）</span>単純な事前処理でj.vバイナリをtkcバイナリに変換できる<span style="font-size:80%">（j.vの逆アセンブラ→tkcのアセンブラ、とすればいいし、設計思想が似通っている以上もっと単純に命令の対応表を作るだけで実装できる。まあ前者の方がどちらかがバージョンアップした時に便利だが）</span>という利便性があったので、このような仕様になった。</td>
	</tbody>
</table>



<h2>27. 外部関数とかライブラリとか</h2>

<p>やっていきたいですね。眠いので、とりあえず何をやらなきゃいかんかだけまとめて寝ましょう</p>
<ul>
	<li>定義していないラベルに飛ぼうとしたら当然ロード時のエラーなわけで、<code>xokison <u>ラベル名</u></code>と書くと「このラベルは別ファイルで定義されてますよ」の合図ということにしよう。</li>
	<li>なおかつ、組み込み関数を用意しておこう。それを<code>xokison</code>してから呼び出すと、特殊な処理が実行される。実装としては、インタプリタ・実機共に「特別なアドレスが存在して、nxがそのアドレスになるとCPUがそのことに気づいてHWを操作する」でよかろう。インタプリタにはせっかく作ったログ出力の機能を実行させたいし、あと「0xa0000000 - 0xaffffffcまで使ってOK」とやるよりも<code>malloc</code>してもらいたいからなぁ</li>
	<li>あ、そういやドキュメント書かなきゃですね。仕様が増える前に一旦書いておくというのも手といえば手か。まあ後で考えよう</li>
	<li>あと、せっかく「ライブラリ=jera」という概念が理語で表現できたのだし、ライブラリについても考えておきたいな。前に書いた開平法とかなんだかんだ使いまわしたいでしょ。実装方法としては、これまた<code>xokison</code>にして、インタプリタの場合はインタプリタ内に既にロードされている命令があってそこにジャンプ、とでもするかな。実機の方は要するにリンカだけど。</li>
	<li>リンカといえば、「<a href="conversations/library.txt">ライブラリ関連の用語(リンカ)とか、ライブラリに対する動詞が自然に料理っぽくなりそうな気がして凄い面白くなりそう</a>」という発言もあったなぁ</li>
	<li>現状だと、コールスタックに積まれているアドレスにreturnすることで実行が終了するけど、これも一種の<code>xokison</code>絡みと見なせないかなぁ。とはいえcallではなくreturnだからなぁ</li>
	<li>呼び出し規約はスタックを使うけど、ハードウェアを操作する命令とかの場合引数はレジスタで渡したい感があるよな。逆に、ハードウェアをいじりたいだけなのに「f1 ~ f3が勝手にいじられている可能性があるぞ」というのもよろしくないし、別の呼び出し規約を作るか。まあ開平法とかは当然現状の規約に従っているわけだし、普通の関数として呼び出せばいいだけだが。</li>
</ul>

<p>寝ます</p>

<h2>28. ログ追加とファイル整理</h2>

<p>「<a href="conversations/jurli_spirit.txt">『こうすると現世っぽくなってしまうからあえて逆にしよう』というような考えは、かえって現世を意識してしまっていることになるので、悠里創作においては好まれません</a>」という話は大事だと思うので、ログを追加した。</p>
<p>あと、過去にまとめていたログもconversations/の下に移した。</p>
<p>ついでに画像をimg/の下に移した。</p>

<h2>29. 外部関数とかライブラリとか（実践編）</h2>
<p>やっていきましょう。とりあえずインタプリタのドキュメントを書かねば</p>

<h3>29-1. レジスタと同名のラベルの禁止</h3>
<p>その前に、<code>nll xx fen</code>が意味解析を通り抜けてしまう細かいバグに気づいたので直していきましょう。</p>
<p>直した。

<h3>29-2. ドキュメント</h3>
<p>仕様が変わる前に、インタプリタの現仕様のドキュメントを書いた。<a href="assembler/interpreter_settings.html">インタプリタの追加設定一覧（暫定）</a>に置いてある。</p>

<h3>29-3. 呼び出し規約の整理と拡張</h3>
<p>現状の呼び出し規約、ちょっと自由度高いし、もうちょい束縛したものも考えてみたい。その方が効率上がるかもだし。</p>
<p>まずf0, f1, f2, f3を破壊するかどうか。「破壊していい」がデフォルトだけど、関数によっては破壊しないでくれる方が呼び出し側にとって助かるということもあったりするかも。他には、逆に破壊するにはするけどf1 ~ f3を戻り値としても利用できるような規約があってもいいかも。要するに、「関数のバージョンが上がってもf1は一定値を返し続ける保証」ということ。</p>
<p>あとスタックに積んだ引数に関しても、「破壊しない」「自由に破壊してよい」「有効な値を返す」の3通りがありうる。例えば、lakormeruは関数から返ってきたときにはf0に平方根の整数部分を格納しており、引数のあったところに「元の引数と戻り値の2乗との差」を格納している。これは実装がそうなっているというのもあるが、共に活用できうる情報であるので、「有効な値を返す」保証というのを付与するのも良さそうである。</p>
<p>えーと、「自由に破壊してよい」が最も広い概念で、「破壊しない」と「有効な値を返す」がそれの2つの異なる特殊化だから、無修飾なら無保証、「破壊しない」と「有効な値を返す」についてはなんらかの修飾子を指定という感じでいいか。その修飾子をどこに書くかという問題は残るが。</p>
<p>まあ、理想的にはCのヘッダ的なことをやったりしたいよね。機械に読める関数のドキュメント作って、それを元にどうこうといった感じで。「静的解析して規約が満たされていないときに文句言う」とかはアセンブラの領分を超えている気がするけど、インタプリタとしてはそういう機能があってもいいかも。</p>
<p>とりあえず、表現方法を考えるか。「自由に破壊してよい」が00、「破壊しない」が01、「有効な値を返す」が10、「そもそも存在しない」が11という風に2bitで表せばf0 - f3のを8bitで表せて、引数の情報も表せる。</p>
<p>今までに作った関数でやってみるなら、</p>

<table>
	<thead>
	<tr><td>関数名</td><td>f0</td><td>f1</td><td>f2</td><td>f3</td><td>第一引数</td><td>第二引数</td><td>第三引数</td><td>第四引数</td></tr>
	</thead>
	<tbody>
	<tr><td>fib1</td><td>10</td><td>00</td><td>00</td><td>00</td><td>01</td><td>11</td><td>11</td><td>11</td></tr>
	<tr><td>fib2</td><td>10</td><td>00</td><td>01</td><td>01</td><td>01</td><td>11</td><td>11</td><td>11</td></tr>
	<tr><td>ycax</td><td>00</td><td>00</td><td>00</td><td>00</td><td>01</td><td>01</td><td>01</td><td>11</td></tr>
	<tr><td>lakormeru</td><td>10</td><td>00</td><td>00</td><td>00</td><td>10</td><td>11</td><td>11</td><td>11</td></tr>
	</tbody>
</table>
<p>という感じ。32bit使うなら引数12個までいけるやん！12個引数取る関数もそうそうないだろうし（←フラグ）これで大丈夫でしょ</p>

<p>どちらかと言うとあれか。マクロ的なものとして「00なレジスタの値をスタックに退避して、呼び出した後に復帰させる」みたいな構文が作れるみたいな感じか。あとは、内容が保証されていないレジスタにアクセスしたらwarning出すとか。</p>

<p>さて、2進で表す方法はともかく、アセンブリ言語側でそういうことを表現する方法も作らなきゃな。</p>
<p>話変わるが、todoに書き忘れたけど「これは外部から見える関数です」ということを宣言するアレも必要。</p>

<p>まあこれで「別の呼び出し規約を作る」案件は解決した気がする</p>
<p>ん？いや待てよ、f0 ~ f3を関数が読むかどうかもビットで指定しなきゃいかんかも？引数は読まれることが大前提だからいいとして。まあいいか、レジスタも引数みたいなもんだ、「勝手に読まれることがあるかも」って扱いでいいのでは？（雑）</p>
<p>んーでも普通読まないこと前提だからなぁ。ハードウェアを操作するとかの特別な命令とかの場合だけ引数をレジスタで渡したい感はあるし、1bit増やすか。引数2つ削るだけでイケる。読むなら1、さもなくば0</p>
<p>ということで改訂版</p>
<table>
	<thead>
	<tr><td>関数名</td><td>f0</td><td>f1</td><td>f2</td><td>f3</td><td>第一引数</td><td>第二引数</td><td>第三引数</td><td>第四引数</td></tr>
	</thead>
	<tbody>
	<tr><td>fib1</td><td>010</td><td>000</td><td>000</td><td>000</td><td>01</td><td>11</td><td>11</td><td>11</td></tr>
	<tr><td>fib2</td><td>010</td><td>000</td><td>001</td><td>001</td><td>01</td><td>11</td><td>11</td><td>11</td></tr>
	<tr><td>ycax</td><td>000</td><td>000</td><td>000</td><td>000</td><td>01</td><td>01</td><td>01</td><td>11</td></tr>
	<tr><td>lakormeru</td><td>010</td><td>000</td><td>000</td><td>000</td><td>10</td><td>11</td><td>11</td><td>11</td></tr>
	</tbody>
</table>
<p>なんか無駄が多い（レジスタに11は不要、とか）気がしないでもないが、まあいいか。自由度は高い方がええやろ（ホントにー？）</p>
<p>ここらで「呼び出し規約の整理と拡張」を一旦閉めようかな</p>

<h2>30. 組み込み関数の実装</h2>
<h3>30-1. アドレスと役割</h3>
<p>はい。そろそろ本当に実践していきます。</p>
<p>とりあえずデバッグ出力する外部関数から作っていきましょうね。とりあえずアドレス決めましょう</p>
<p>特殊判定されるリターンアドレスは0xbda574b8なので、とりあえず（Math.randomによるダイスロール）0xba5fb6b0 = 3126834864にでもするか。名前は…後で考えよう。</p>
<p>さて、何を実行させよう？とりあえずデバッグ出力だよな、でも何を出力させよう？うーん。</p>
<p>いや、デバッグ出力じゃなくて普通に出力する用の関数を考えればいいのか。そうすればOSができた後でアプリケーションとして使うこともできるし。</p>
<h3>30-2. 「関数呼び出し」って何て言う？</h3>
<p><a href="conversations/call.txt">「関数呼び出し」のリパライン語訳</a>について話し合った。fenxe「(食事を)運ぶ　もって行く」で表現されることとなった。<a href="https://sites.google.com/site/panqateel/yougo">用語集</a>に追記した。</p>

<h3>30-3. 実装しような</h3>
<p>実装していきます。<a href="https://twitter.com/Vane11ope/status/912868499520761856">printf</a>（<a href="https://twitter.com/sosoBOTpi/status/912869331486121984">数が出力されればそれでいい</a>）が欲しいとのことなのでやっていきます。</p>
<p>とりあえず関数をどう実装していくかという話ですな。まあインタプリタに組み込んでしまうのが無難ではありそう。さてやっていくか</p>
<p>うーむ、ハードコードでレジスタをちゃんと正しく操作できる自信がないなぁ…</p>
<p>と思ったらnop関数は楽に実装できた。そして普通にデバッグ出力できた。やったぜ。（テストするときにcallでなくjumpして一瞬詰まった、というのがアレだが）</p>
<p>とりあえず、仕様に書いて更新するか</p>

<h3>30-4. 説明追加</h3>
<p>デバッグ出力がどういうことをするのかの説明が不足していて誤解を与えたので、それの説明をし、それに関して<a href="conversations/debug_output.txt">会話ログ</a>を足した。</p>

<h2>31. 別名追加</h2>
<p>未実装の<code>nac f5@</code>って結局<code>dal 0 f5@</code>で実現できるよね。はい、別名として実装します</p>

<h2>32. xokisonとリンカもどきと外部ライブラリ</h2>
<h3>32-0. 方針</h3>
<p>数値で関数を呼ぶのはどう考えても移植性がないので、ちゃんと名前を割り振らなきゃですな。さて標準ライブラリ（？）ってどこに置こう。あと、もちろんライブラリをユーザー側で作れるようにしなきゃね。さて、今のインタプリタってファイルの先頭から実行していって、どこにも<code>main</code>みたいな印がないけどどうしよう。じゃあ逆転の発想で、ライブラリは全部ライブラリだと明記するか。ライブラリは必ず関数をexportしてるはずだし、逆に<code>main</code>は関数をexportする必要がない。じゃあexport宣言があるのがライブラリで、そうでなければライブラリでないってことにするか。理想的ではないかもしれないが、まあアリな方針でしょ。さて、関数のexportってどうやって行おう。</p>
<h3>32-1. 構文</h3>
<p>さて、どういう構文にしようか。<a href="https://twitter.com/sosoBOTpi/status/913864613170573312">kinunsares（公開する）にしたいが、ちょっと長い気もするなぁ</a>。</p>
<p>そういえば、【対応する機械語が存在するわけではない、アセンブラ側に伝えるためだけの構文】（過去に書いた文章見ると「擬似命令」って書いてあるな）って現状<code>'i'c</code>と<code>'c'i</code>しかないけど…と思ったら<code>l'</code>と<code>nll</code>も一応あるな。うーん</p>
<p>とりあえず、何らかの形でkinunsaresを省略したものを構文にしたいが、<a href="https://twitter.com/sosoBOTpi/status/913875670312271872">リパラオネ人の略語の感覚が掴めないのが悩ましい</a>。</p>
<h3>32-2. 話は変わるが</h3>
<p>Togetterが<a href="https://togetter.com/li/1156125">増えた</a>。ついでに、先週（9/23あたり）にまとめたpart2へのリンクも<a href="https://togetter.com/li/1153844">貼っておこう</a>。</p>
<p>このページの先頭とかにも貼っておくか。</p>
<h3>32-3. kinunsares改め<code>kue</code></h3>
<p>とりあえず、複数ファイルを扱う機構だけでも作ってしまおうかなぁ。先にコードを組んでおいて、後でkinunsares相当を入れればいいだけだし。</p>
<p>と思ったら「<a href="https://fafss.slack.com/archives/C70CBNYN7/p1506747683000056">kinunsares、形態素ごとに略しそう</a>。<a href="https://fafss.slack.com/archives/C70CBNYN7/p1506747690000038">kueかな</a>」と言われたので確定。</p>
<h3>32-4. <code>kue</code>の実装</h3>
<p>とりあえず、<code>'c'i</code>か<code>'i'c</code>かぐらいしか記録していなかったパーサーの内部状態をいじって、kueの情報も載せることにしよう</p>
<p>kueの情報もパーサーから返せるようにしたので、今度はmain.hsを調整しよう</p>
<p>概形はできたが、問題はリンクだな。というか<code>xokison</code>実装し忘れてるやん</p>
<p>実装した。さてリンカについて考えよう。</p>
<h3>32-5. リンカ</h3>
<p>現状は<code>Instruction</code>の中にラベルがそのまま仕込んであって、実行時にラベルを見てラベルテーブルから検索してそこに飛ぶという処理にしている。つまりExecuteの方も調整する必要がある。</p>
<p>Executeを見てみるとgetValueFromRという関数内でラベルの解決をしている。これをリンカに任せたい。んー、M.lookupを抽象化すれば十分かもなぁ</p>
<p>とりあえずLinker.hsみたいなものが不可欠か。</p>
<p>単一のファイルのみを扱えるリンカ（リンクできるとは言っていない）を実装。</p>
<h3>32-6. 抽象化</h3>
<p>とりあえずTentativeLoadを用いているところを全て抽象化できたので、あとはリンカを正しく実装するだけ。</p>

<h2>33. 諸々</h2>
<p>リンカについて考えたりしている間にあった諸々をまとめておく</p>
<h3 id="i33_1">33-1. バイナリ案</h3>
<p>9月26日(UTC+09:00)に炭酸ソーダさん（<a href="https://twitter.com/na2co3_ftw">@na2co3_ftw</a>）がバイナリ案を考えてくださった。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">2003fのバイナリ案を勝手に。 <a href="https://t.co/BQb025YKwj">https://t.co/BQb025YKwj</a> こういうことするならちゃんとFAFssに入った方がいいのかな</p>&mdash; 炭酸ソーダ (@na2co3_ftw) <a href="https://twitter.com/na2co3_ftw/status/912547272310661120?ref_src=twsrc%5Etfw">2017年9月26日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<h3>33-2. Web版インタプリタ</h3>
<p>9月30日(UTC+09:00)に炭酸ソーダさん（<a href="https://twitter.com/na2co3_ftw">@na2co3_ftw</a>）がWeb版インタプリタを作ってくださった。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">2003fををGUIでステップ実行できるやつ作った <a href="https://t.co/xcxKRxG13N">https://t.co/xcxKRxG13N</a></p>&mdash; 炭酸ソーダ (@na2co3_ftw) <a href="https://twitter.com/na2co3_ftw/status/914083826183241728?ref_src=twsrc%5Etfw">2017年9月30日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<h3>33-3. Togetterと用語</h3>
<p><a href="https://togetter.com/li/1156791">Togetterが増えた</a>。副産物として、『<a href="https://twitter.com/sosoBOTpi/status/914674648624750592">関数として用いない、純粋な「ラベル」をリパでどう言うか</a>』『<a href="https://twitter.com/sosoBOTpi/status/914675367813640192">fiでセットしてmalkrzで読むフラグの具体的な名前</a>』という2つの案件が発生した。後者は<a href="https://twitter.com/sashimiwiki/status/914686280910254080">fio'd famian</a>で良さそう。</p>
<h3>33-4. 334</h3>
<p>な阪関無</p>

<h2>34. リンカの実装</h2>
<p>やっていきましょう。</p>
<h3>34-1. エラー</h3>
<p>TentativeLoadの関数を<code>Either String TentativeLoad</code>じゃなくて<code>Either LoadError TentativeLoad</code>にしようかと思ったが、唯一存在するエラーが<code>"duplicating label(s): " ++ intercalate ", " (map unLabel labels)</code>なので、これは<code>LinkError</code>でいいでしょう。</p>
<h3>34-2. ロード</h3>
<p>ロード地点を順次変えていけばいいわけだが、さてそうなるとサイズ制限をかけなきゃだよな。どれぐらいにしようか。</p>
<p>2005年に<a href="http://www.atmarkit.co.jp/bbs/phpBB/viewtopic.php?topic=28960&forum=26">64KB制限で苦しんでいる人</a>を見つけた。j.vバイナリは1命令が約4byteだから、64KBとなると16384命令か。<a href="https://twitter.com/sosoBOTpi/status/914972032302907392">「どうやっても64KB以下にならない」と苦しむ後世のエンジニアの顔が見え</a>てたのしいので採用。</p>
<p>プログラム全体のサイズならともかく、単一ファイルの、しかもデバッグ用のインタプリタでの制約ならこれぐらいで十分と判断されてもおかしくないでしょ。後世が困りそうだけど。</p>
<p>そういえば、万進のリパラインでキロバイトとかってどう言うんだろうね。</p>
<p>とりあえず、64KBということは65536byteだから、アドレスに65536 = 0x00010000を足していって次々にロード、という感じか。</p>
<p>その前に、mainが重複したらエラーを吐くようにせねば。重複検出を備えたtoListはよく使うのでリファクタリングしよう。</p>
<p>main重複でエラー、mainがなくてもエラー、そしてとりあえずロードを実装した。<strong>64KBを超えても警告は出ない</strong>。</p>
<p>さて、モナドを解決しよう。まずStringをLinkErrorにするところから。</p><p>問題はmapMがData.Map.Mapにおそらくないだろうことだ</p>
<p>あるやん。traverseWithKeyというらしい。さすが。</p>
<h3>34-3. リンク</h3>
<p>さて、ありがたいライブラリ関数のおかげてロードまでは終わった。コードを整理して、次はリンクだ</p>
<p>とはいえ、リンクはどう解決したものか。まあ案はあって、飛ぶときにはnxの位置を見ればどのファイルに由来するラベルかが分かるので、実行時に名前解決すればいい。</p>
<p>とりあえず、命名規則を統一したいので関数を改名、定義の順番も入れ換えた</p>
<p>待てよ、ロードしたプログラム自体はリンクしないと。Data.Mapをくっつければいいかな。</p>
<p>さてさて、よく考えると、0x00010000刻みでロードしている以上、逆引きとかの手間を考えるとロード位置は0xqqqq0000であるべきだよな。変えよう。</p>
<h3>34-4. 仕様変更</h3>
<p>仕様変更といってもインタプリタ側のみの変更。初期ロード位置を0x1482e8d4 = 344123604から0x14830000 = 344129536に変更。</p>
<h3>34-5. エラー</h3>
<p>やっぱり64KB超えたら警告出すべきだよな（それはそう）。検出機構組みましょう。</p>
<p>組んだ。</p>
<h3>34-6. リンクpart2</h3>
<p>現在のNXの情報をもらうようにする。あと、とりあえずProgram'の型を書く。</p>
<p>readNXは実装完了。currentNXに対応するところのページを開いて、アドレスをlookupするだけの簡単なお仕事。</p>
<p>resolveLabel'はもうちょいめんどい。さて、どういうことをしなきゃいかんか考えてみよう</p>
<ol>
	<li>まず、同一ページにラベルがあるかどうか確認する。あれば終了。</li>
	<li>なければ、xokを確認する。xokに無いものは読んではいけないので、xokにないならエラー。</li>
	<li>xokにあったら、他のファイルがkueしているやつの一覧を…あらかじめ作っておかなきゃな。</li>
	<li>一覧を読んで、ないならエラー、あるなら該当するページに飛んでラベルを入手。</li>
</ol>
<p>そういえば、内部定義とxokが被ったときにエラー出さなきゃだな。</p>
<p>あと、kueしているラベルが不存在ならそれもエラー。</p>
<p>複数のファイルが同一の名前をkueしていたらエラー。</p>
<p>xokしているラベルをkueするのは？まあいいでしょう。関数を横流しするファイル。</p>
<p>さて、ということで、一覧も作ってリンクエラーもちゃんと出してあげなきゃいけないことがわかりました</p>
<h3>34-7. エラーpart2</h3>
<p>内部定義とxokが被ったときにエラーを出すように。</p>
<p>kueしているラベルが不存在の時もエラーを出すようにした。</p>
<p>待てよ、よく考えたら現状だと横流しすると重複定義エラーが出るな？めんどいので横流しは実装しないでおこう</p>
<p>コードもシンプルになった。</p>
<p>さて、複数のファイルにまたがってkue警察をせねば。sanitizeKueという名前にしようかな</p>
<p>重複検出付きfromListのおかげでかなり楽に実装できた。</p>
<h3>34-8. リンクpart3</h3>
<p>さて、実装を終わらせていきましょう</p>
<p>終わりました。多分。</p>
<p>fibを分割してみたけど実行できたので、問題なさそう。</p>
<p>さて、説明書いて寝るか。</p>
<p>説明書いた。</p>

<h2>35. メッセージ改善</h2>
<h3>35-1. メモリ出力</h3>
<p>境界違反した時のgarbageだと、具体的にどのアドレスにアクセスしてしまったのかが分からないので、それを表示するように。</p>
<p>また、数値は右揃えの方がいいので、右揃えにした。</p>
<h3>35-2. 理語でエラーメッセージ</h3>
<p>理語でエラーメッセージを出すための準備をせねばなぁ。</p>
<p>とはいえ、どう実現したものか。実行時に切り替えるものである以上、IOの近くで使いたいわけで。</p>
<p>まあ、全部のエラーメッセージをどこかに登録して、IOのところでShowではなく別の処理を使うようにする、とかだろうな</p>
<p>エラーメッセージ以外のメッセージについても対処したいよね</p>
<p>ということで、とりあえずラッパを被せた。</p>	
<h2>36. 掛け算と割り算</h2>
<p>いい加減やっていきましょう。</p>
<ul>
<li>掛け算：果たして常に64bitを要求すべきか？</li>
<li>割り算：ゼロ割りどうしよう。商を不定値、余りを入力にするとか？あと、負の数がらみをどうするか</li>
</ul>
<p>という案件があるのだ</p>
<h3>36-1. 算術右シフト</h3>
<p>算術右シフトが必要。実装は一瞬だが<a href="https://twitter.com/sosoBOTpi/status/916348109994598401">命名をせねば</a>。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">nysがny snakxazで「非負の」の略なので、snaをくっつければいいか？「負の」ってのは微妙な気がするが <a href="https://t.co/Nq7t7tUCsN">https://t.co/Nq7t7tUCsN</a></p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/916348568960516098?ref_src=twsrc%5Etfw">2017年10月6日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">snakxazasyk「負が可能な」とするか？（理語として大丈夫だろうか <a href="https://twitter.com/sashimiwiki?ref_src=twsrc%5Etfw">@sashimiwiki</a>）</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/916379928412565504?ref_src=twsrc%5Etfw">2017年10月6日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>ということで、とりあえず暫定的にsnakxazasyk「負が可能な」という訳語を当てる。</p>
<p>んで算術右シフトはdtosnaでよかろう。</p>
<p>実装した。</p>
<h3>36-2. 掛け算の仕様</h3>
<p>まずは掛け算から。とりあえず、どれくらい選択肢があるかというところから考えていこうか。</p>
<p>そうすればダイスロールできるし。</p>
<p>長い時間迷いすぎている時はダイスロールを使うべしというのが鉄則なわけで。</p>
<ol>
	<li>「32bitのみ」 or 「64bitのみ」 or 「32bitと64bitで命令が2つある」</li>
	<li>64bit演算の上位ビットを格納する場所は「固定」or「オペランドで指定」</li>
	<li>64bit演算の下位ビットを格納する場所は「固定」or「被乗数の位置」</li>
	<li>被乗数の位置は「固定」or「オペランドで指定」</li>
	<li>乗数の位置は「固定」or「オペランドで指定」</li>
</ol>
<p>1.については、32bitのみだと浮動小数点数をソフトウェア的に実現したいときに不便なのでなぁ、という感じ。</p>
<p>5.については、乗数が定数だったりするわけで、オペランド指定一択でしょう。さて2.と3.と4.ですな</p>
<table border="1">
	<tr><td><td>上位位置：固定<td>上位位置：可変
	<tr><td>下位位置：固定、被乗数位置：固定<td>x86のmul<td>
	<tr><td>下位位置：固定、被乗数位置：可変<td><td>
	<tr><td>下位位置：可変、被乗数位置：固定<td><td>
	<tr><td>下位位置＝被乗数位置：可変<td>今の枠組みに上手く当てはまりそう<td>
	<tr><td>下位位置：可変、被乗数位置：可変<td><td>
</table>
<p>x86の仕様を調べてきた。なるほど、<code>imul</code>が複数オペランドで実行された場合は上位32bitは捨てられるのか。</p>
<p>思いついた案：上位位置と下位位置に同じ位置を指定した場合、上位位置の情報が消える</p>
<p>もうこれでいいか。このアセンブリ言語、とりあえず命令の種類を節約するのが大好きだし。</p>

<h3>36-3. 掛け算の構文</h3>
<p>さて構文考えよう。</p>
<p>えーっと<code>ata</code>の比喩を取るなら、<code>'i'c</code>の時は<code>lat</code> <u>乗数</u> <u>被乗数=下位</u></code>で<code>'c'i</code>の時は<code>lat</code> <u>被乗数=下位</u> <u>乗数</u></code></p>
<p>上位ビットどうしよう。</p>
<ol>
	<li>固定で第三オペランド</li>
	<li>下位ビットの左</li>
	<li>下位ビットの右</li>
</ol>
<p>ダイスロール！1,4; 2,5; 3,6で割り振ろう。</p>
<p>回したら3。じゃあ下位ビットの右で。</p>

<h3>36-4. 掛け算の実装</h3>
<p>実装しましょう。</p>
<p>まず構文解析。</p>
<p>そして実装。</p>

<h2>37. 「計算する白色」</h2>
<p>いわゆるtkcバイナリの名称が決まった。</p>
<table>
	<tr><td>日本語</td><td>「計算する白色」</td></tr>
	<tr><td>アルテナ語</td><td>ubeefazi plon</td></tr>
	<tr><td>リパライン語</td><td>lex litarle flan</td></tr>
</table>
<p>あと、「計算する白色」（略称: ubpl）が開発された経緯についても<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507374396000059">まとめた</a>。</p>
<div class="box">
	<p>「計算する白色」が開発された経緯：
2003fは、命令数は少なく（この点でのみ一見RISC的）、その分の表現力を直交性に回す（直交性に加え、単一の命令で複数の処理を行う、可変長命令であるなどの点を考慮すると、思想としてはCISCの方が近い）という設計思想だった。一方、その直交性の高さは高速化にとっては不便な代物であったので、科学技術などの高速計算には向かなかった。 故に、科学技術計算用の、高速に実行できるアーキテクチャの需要があった。とはいえ、2003fのコード資産が多かったため、それを最大限活用すべく、「2003f用のアセンブリ言語からアセンブルできるバイナリ」として設計されたのが「計算する白色」である。</p>
</div>
<p>ちなみに、直交性が高いというのは、<a href="https://ja.wikipedia.org/w/index.php?title=%E7%9B%B4%E4%BA%A4%E6%80%A7_(%E6%83%85%E5%A0%B1%E7%A7%91%E5%AD%A6)&oldid=39067719">Wikipedia</a>の記事にあるように、諸々の組み合わせの制限が少ない（というか殆ど無い）ことを意味する。</p>

<h2>38. 入門書</h2>
<p>入門書書くか</p>
<h3>38-1. 2003lk</h3>
<p>そういえば、ubplが出てきたことによって、アーキテクチャとしての2003fとそこで用いられるアセンブリ言語とを区別しなきゃいけなくなるわけだけど、9月23日あたりに言っていた「<a href="https://fafss.slack.com/archives/C70CBNYN7/p1506109923000318">アセンブリ言語の名前、2003lkとかにしようかなぁ</a>」という案を採用しよう。言った本人j.vは忘れてたけどtkcは覚えてたし。</p>
<p>ということで「<a href="https://sites.google.com/site/panqateel/yougo">用語集</a>」に足してきた。あと、<a href="./assembler_introduction/index.html">入門書</a>では今後なるべく2003lkの名称を用いるようにする。</p>
<h3>38-2. ようこそ</h3>
<p>ようこそ的なことを書く。あと、執筆年は（ダイスロール）phil.2005年2月ということにしておこう。</p>
<h3>38-3. 非真理設定</h3>
<p>真理設定とそれ以外を分離して扱う方針を明記。</p>
<h3>38-4. そういえば</h3>
<p>炭酸ソーダさんのバイナリ案（<a href="#i33_1">33-1.</a>を参照）ではf7を潰して111をxxに当ててるんよね。基本的にこの方針に賛成なので、f7を設定から取り除いておこう。</p>
<p>今まで先延ばしにしておいた理由は、「xxをf4に当てて、f6とf7を単一の64bitレジスタにするのはどうか？」という考えがあったけど、掛け算の仕様も決まったし、あと「ハードウェア側で大事な情報とっておくのには余剰レジスタが2つぐらいあったほうがいいよね」という思いもあるので、f7を削除。</p>
<h3>38-5. 掛け算</h3>
<p>64bit掛け算だとny snakxazとsnakxazasykで挙動変わりますな（なぜ気づかなかった）</p>
<p>入門書から掛け算に関する記述を消して、と</p>
<p>とはいえ、この64bit掛け算って浮動小数点数とかをサポートするための実装だしなぁ、snakxazasykは実装しなくていいんじゃないかな</p>
<p>やっぱ実装します</p>
<p>実装しました</p>
<h3>38-6. 用語</h3>
<p>lkurftlesse'd lineparineなのに2003f'd lkurftlessなの不統一じゃない？とか思ってlkurftlessという語を避けてたが、『<a href="https://fafss.slack.com/archives/C7DC7976K/p1507442489000040">lkurferlは「話す内容」なわけなんだけど、言語を指すってイメージがあまりない。</a>』とのことなので（辞書に「lkurferl：言語」と載ってたが、改修するらしい）、こちらもlkurftlessに置き換える。</p>
<p>あと節は<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507444126000025">lexn</a>らしい。</p>
<h2>39. 用語と歴史</h2>
<h3>39-1. 用語と歴史の議論の過去ログ</h3>
<p>数日前にあった重要な議論を、遅ればせながら掲載する。</p>
<p>バイトを意味するmejという語は、理語辞書にある通りユーゴック語由来である。しかし、2003fが開発された時代は<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507131465000221">ユエスレオネはハタ王国に出会ったばっかりで国力的にも差がある</a>時代で、<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507131702000574">2003年前にユーゲ人との言語的接触は<b>ほぼ</b>ないことになってる</a>ので、mejというのはそれ以降に入ってきて定着した語ということになる。</p>
<p>ということで、現世の10月5日(日本時間)あたりに『<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507133645000143">ビット・バイトについては「ビット・バイトとかはリパにもあったけど、現世の「ワード」のようにだんだん廃れていってユーゴックが定着した」という設定</a>』となった。</p>
<p>後にユーゴック語が定着するようになるきっかけとしては、<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507133472000362">ユーゴック語圏との接触時までにハタ王国は産業革命レベルの発達状況だったはず</a>であることから、<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507133483000238">追いつけ追い越せ的な</a>、<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507133516000265">日本（の明治時代）的な計算機研究の発達があった</a>のではないか？という話になった。</p>
<p>以上のことから、<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507133645000143">2003f関連で用いられる用語はユーゴック語由来の表現を基本的に含むべきでないこと</a>、<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507134003000167">基本的に32bit操作しかない以上、2003fの時代には全部ビットとワードでやっていて、バイトはなかったのかもしれない</a>ことなどの方向性が定まった。</p>
<p>10月9日に、『ビットのことを「スイッチ」（lysol）と呼んでいた入門書に揃えて、ワードのことはスイッチの複数形（lysolass）と2003f時代は呼んでいた』といった感じにすることとした。物理的な「スイッチ」と抽象的な「ビット」と単位としての「ワード」が紛らわしいこと、また後世は32bit固定ではないことなどがきっかけとなって、後にユーゴック由来のバイト（mej）という単位が定着することとなったと考えれば自然である。</p>
<h3>39-2. 有語分離</h3>
<p>さて、39-1.で出てきた「2003f関連で用いられる用語はユーゴック語由来の表現を基本的に含むべきでない」という原則を元に用語集を見直してみたところ、いくつかユーゴック語由来の表現が発見された。このページでは2003fの話しかしていないのでそろそろみなさん忘れてきている頃かもしれないが、悠里OSプロジェクト自体は2003f以降の歴史も掲載する場所であるため、ユーゴック語由来の表現は削除するのでなく別表に分離した。ちなみに、xarzni'arの語源に有語が含まれていたのが驚きである。</p>
<p>ついでに、未掲載だったいくつかの用語も掲載することにした。ついでにそれに関する歴史設定も追記。</p>
<ol>
	<li>ladirvirel「アセンブリ言語」：もともと-dirがチェックに引っかかったので載せないでいたのだが、実は-virelも翻訳借用による接尾辞であることが発覚、akrunftaxmavirleの摘発に繋がった。理語は「本来の言語」という意味であるが、「本来の言語」という考え方自体が、後世にできた高級言語と対比した呼び方であり、2003f当時にはなかった概念である。故に、この語は自明に後世にできた語であり、有語を含んでいて全くおかしくない。2003lkという名前から分かるように、2003f当時は「アセンブリ言語」という分類の枠組みはなく、具体的なアーキテクチャ名を指して「◯◯の言語」と呼んでいた。</li>
	<li>mej「バイト」：前述の議論のきっかけとなった語である。辞書に『ユーゴック語のmei「バイト」の借用である』と書いてある以上、2003f以降に借用された単語である。理語にはもともと「ワード」を表すlysolassという語があったが、アーキテクチャによってビット数が変わりうることと、物理的な「スイッチ」と抽象的な「ビット」と単位としての「ワード」が紛らわしいことから、lysolassは後に使用頻度が減り、語形が短く一意的なmejが定着することとなった。</li>
	<li>lysolass「ワード」：2003fの頃にmejの代わりに用いられていた単語。データ量の単位で、具体的に何ビットを指すかは状況によって異なるが、2003fでは専ら32ビットを指す。理語は「スイッチ」の意味の語lysolの複数形。一意的でないこと、「スイッチ」そのものと紛らわしいことなどから、後に多くの場合においてユーゴック語由来のmejに取って代わられるようになった。</li>
</ol>
<h3>39-3. xarzni'ar</h3>
<p><a href="conversations/xarz.txt">xarzについて話をした</a>。<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507706410000238">xarzという語は早い段階で借用され、xarzni'arという語と共に早い段階から理語に定着した</a>ので、xarzni'arvenは例外的に2003fの時代に用いられうる単語であるということとなった。</p>
<h3>39-4. 用語集のミラー</h3>
<p>用語集が<a href="https://sites.google.com/site/panqateel/yougo">Google Pagesだけにしかない</a>というのも（gitと同期できない点とかが）不便なので、こちらで<a href="./yougo.html">ミラーサイト</a>を作ることにした。</p>
<p>xarzni'arに関する記述を用語集に足した。</p>
<h3>39-5. パイグ語</h3>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">メモリ　筆付　kua2 kun2<br>レジスタ　激付　gak1 kun2<br>プログラムカウンタ　軸付 la1 kun2<br>EIPレジスタ　下付　ut2 kun2</p>&mdash; S.Y@S.Y (@S_Y15) <a href="https://twitter.com/S_Y15/status/918113273123258369?ref_src=twsrc%5Etfw">2017年10月11日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">イエロースクリーン　如止　em muo1<br>アスペクト比　広別　zie1 bau2<br>右辺値　目端　ta1 tau2<br>左辺値　筆端　ak2 tau2</p>&mdash; S.Y@S.Y (@S_Y15) <a href="https://twitter.com/S_Y15/status/918115608918552577?ref_src=twsrc%5Etfw">2017年10月11日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">関数　律　iak1<br>ライブラリ　律集　iak2 dat2<br>CPU　裁軸　xiu1 la1</p>&mdash; S.Y@S.Y (@S_Y15) <a href="https://twitter.com/S_Y15/status/918116993873592321?ref_src=twsrc%5Etfw">2017年10月11日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
（<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507739074000497">iak2 dat2はiak1 dat2の誤り</a>）
<p>ということで、</p>
<table><tr><td>メモリ</td><td>筆付</td><td>kua2 kun2
</td></tr><tr><td>レジスタ</td><td>激付</td><td>gak1 kun2
</td></tr><tr><td>プログラムカウンタ</td><td>軸付</td><td>la1 kun2
</td></tr><tr><td>EIPレジスタ</td><td>下付</td><td>ut2 kun2
</td></tr><tr><td>イエロースクリーン</td><td>如止</td><td>em muo1
</td></tr><tr><td>アスペクト比</td><td>広別</td><td>zie1 bau2
</td></tr><tr><td>右辺値</td><td>目端</td><td>ta1 tau2
</td></tr><tr><td>左辺値</td><td>筆端</td><td>ak2 tau2
</td></tr><tr><td>関数</td><td>律</td><td>iak1
</td></tr><tr><td>ライブラリ</td><td>律集</td><td>iak1 dat2
</td></tr><tr><td>CPU</td><td>裁軸</td><td>xiu1 la1
</td></tr></table>
<p>となった。<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507739015000465">偶然</a>にもライブラリに<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507739004000212">juak感</a>があるので、<a href="https://fafss.slack.com/archives/C7B6XV2P8/p1507739033000003">さらに混乱が捗りそう</a>である。（会話ログは<a href="./conversations/juak.txt">こちら</a>からどうぞ）</p>
<p>用語集にも追記した。</p>

<h3>39-6. ユーゴック語とカラムディア</h3>
<p>2017/10/17 01:30あたり:</p> 
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ユーゴック方面の情報史も考えなきゃだよなぁ。理語への語彙流入のきっかけとかも確定していないし（「リーナス・トーバルズ相当とかドナルド・クヌース相当がカラムディアから出た」ぐらいしか案を思いついていない）</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/919963669995208704?ref_src=twsrc%5Etfw">2017年10月16日</a></blockquote>
<p>に対して、kpht氏から「<a href="https://twitter.com/fistirnar/status/919964425813049344">実は私もそれくらいのもんしか考えられなくなっていてな。ハタ王国は100年に満たない間に大国に急成長したチート国家なので、社会主義政党やカリアホ＝スカルムレイが成功させてもおかしくないのではと。</a>」という返事（鍵アカ）が来た。まあ、複合的な要因があったにせよ、その中の一つとしてそんな感じのがあったんだろうということにした。アメ車が日本車に負けたりしたわけだし、そんなこともあるやろ。</p>
<p>2017/10/18 17:49</p>
<p>「<a href="https://jurliyuuri.slack.com/archives/C6QL0DKV4/p1508316588000183">用語集ユーゴック語訳追加できた</a>」とのことなので、ミラーサイトにコピー。</p>
<br>
<p>さて、ということはユーゴック語も勉強しなきゃだよな。もちろん、「有語からの借用は非真理設定である」とでもしてしまえば私の言語学習の手間は削減されるわけだが、それではつまらないもんな。チート国家ハタ王国がグングンリードしていって、リパラオネ人ITエンジニアがユーゴック語を学習しなきゃいかん方が面白い。</p>
<p>fafs「そもそも悠里世界の知能職は理語と有語ができないといかん風潮」</p>
<p>j.v「ならなおさらこの設定で好ましいな」</p>

<h3>39-7. ネットワーク</h3>
<p>「<a href="conversations/internet.txt">インターネットが使われ始める時期を決定するのｆēｉｃｈáｎｇ重要だ</a>」という話に。「<a href="conversations/internet.txt">2003f自体の仕様は無事固まりつつあるし、歴史方面に本腰入れていかないとな（今までもそこそこやってはいたが）</a>」となった。</p>

<h3>39-8. rer</h3>
<p>理字rerには、巻き舌のrと長音のrという2種類の役割がある。デュテュスンリパーシェではこの二つを区別するというのが従来の定説だった<sup>[要出典]</sup>が、それについて<a href="conversations/rer.txt">議論</a>が行われた。</p>
<p>結果、「2003fの時代には派閥が3種類ほど存在した」という設定となった。（faistaderという用語自体はすでに造語されていた）</p>
<ol>
	<li>faista'd rer, faistader（「枝のr」）：「発音に応じて巻き舌のrと長音のrを明確に書き分けるべし」という流派。</li>
	<li>etollenel（「伝統的やり方」）：「昔は同一の文字だったし、直前の文字で発音の区別ができる以上書き分ける必要などない」という流派。</li>
	<li>xelkene'd rer（「xelkenのr」）：「長母音をVrとして後世に明確化させたときのみ無声r表記にすべきで、それ以外はRで書くべき」という、最も保守的な流派。</li>
</ol>
<p>外国人教育は合理的なfaistaderで行われ、またFAFssにいたリパラオネ人もfaistader派だったため、2003fのシステムはfaistaderで作られた。ただ、学校教育はetollenelで行われていて、行政文章はxelkene'd rerで書かれており、結局統一はなされなかった。外国人教育はfaistaderで行われ続けたので、理語で書かれた小説では『2種類のrを明確に書き分けることで、話しているのが外国人であることを強調する』という表現技法が生まれた。</p>

<h2>40. 言語と歴史</h2>
<p>39-9.にしようと思ったが、あまりに長いので分割。</p>
<h3>40-1. 燐帝字母の順序</h3>
<p>まず、2017年10月12日~10月13日にかけての<a href="conversations/linzi.txt">議論</a>があった。</p>
<p>「文字コードの制定のために燐字が辞書にどう載ってるかを考えなきゃ」ということで、「字を選出しなきゃ、並べようがない」となり、<a href="https://twitter.com/jclaws_pr/status/837354652198821889">悠里広報が前に出した115字</a>が基本となりそうだという話になった。「パイグ語の何割ぐらいがこの115字で占められるんだろうか」ということで、中国語に適した改良版のZipfの法則について調べるなどした。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">燐字頻度分布のモデルはだいたい立ったが、やはり具体的な話はえすわいに聞いてみないとだな</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/918649414645719040?ref_src=twsrc%5Etfw">2017年10月13日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>10月15日の<a href="https://github.com/jurliyuuri/jurliyuuri.github.io/blob/master/%E7%87%90%E5%AD%97%E5%AD%97%E6%9B%B8%E9%85%8D%E5%88%97.txt">議論</a>で燐字字書が点画配列となることが決まった。</p>
<p>また、「パイグ語がどれくらいの字数を要しそうかとかいう感覚がよう分かっとらん」という話をしたところ、「『燐帝字母』に議論の対象を限るならば、他のラネーメ語族や一部のリパラオネ語族も昔は燐帝字母を使っていたので、パイグ語基準はあまり良くない」という話となった。そこで、</p>
<ul>
	<li>国・地域ごとに文字コードが立ち、後で統合されていった</li>
	<li>なんかの団体が一気に『燐帝字母』全体の文字コード整備を行った</li>
</ul>
<p>のどちらが採用されそうか、という話となった時に、「文字コード整備が必要になるものが作れるようになるのはユエスレオネ時代ちょっと前だろうし、その時点で作っても燐帝字母が入らなさそうと考えると、2003fが初めてなんだろうなと考えた」という話となり、2003fの段階で一気に整理されたということとなった。</p>
<p>j.vはこれを「2003fの時にイェスカの元で一気に整理された」と解釈していたが、これは歴史設定に合わないことが後に判明する。</p>

<h3>40-2. 燐帝字母の立ち位置</h3>
<p>39-8.に収録したrerの議論から派生した話題として起きた、有字のjとxに関する扱い（未収録）から、10月21日に<a href="conversations/linzi_status.txt">議論</a>が派生した。fafs falira sashimi曰く、</p>
<blockquote>
	PMCFとの接触はすくなくともデュイン戦争後でユーゲ人との接触のほうが早いゾ。ユエスレオネ上の大多数は旧リパラオネ連邦人が占めていたから大多数はリパライン語を話す人々でいせにほのフェリーサみたいなのは少数だゾ、だから燐字もまず初期文字コードに含まれる理由が説明できない。
</blockquote>
<blockquote>
	2000年代のユエスレオネ人で日常的に燐字を使っている奴はまず居ないので不要不急で何故追加したのかは謎。燐字も有字も特別扱いはない。
</blockquote>
<p>とのこと。</p>
<p>珍しく数多くの人が活発に参加する議論となり、以下のような真理設定が生まれた。</p>
<ul>
	<li>2003fの名は、計画開始した年がphil.2003年だったことによるものであり、実際の開発は早くともphil.2003年後半から始まった。</li>
	<li>連邦は特に2003年辺りの時期は外貨も欲しくないので、政治思想に沿わないPMCFへの対応は無視していた。故にphil.2003年当時はローカライズの動機はなかった。phil.2005年には市場経済化しており、ローカライズとそれに伴った文字の大量追加はそこでされそうである。</li>
	<li>発見当初のPMCFと連邦との意思疎通は、連邦側にいたアイル語話者がメインだった（当時のPMCF共通語はアイル語）。初期はバート人とリパラオネ人がアイル語で話したりして、アイル語を中間言語としてリパライン語教えこむといった感じだったのだろう。ただし、もちろんユーゲ人はリパライン語だし、PMCFでもリナエスト人なんかはアイル語を喋らないわけで、チームの公用語はリパライン語である。（cf. 「休み時間に研究所の端でアイル語で話す集団と理語ではなす集団で人間関係が分かれそう」）</li>
</ul>

<h2>41. 用語回収</h2>
<h3>41-1. 料理派生</h3>
<p>過去(<a href="#i26_1">26.1</a>）に掲載した<a href="conversations/library.txt">ライブラリ</a>議論で出てきた「ライブラリ関連の用語(リンカ)とか、ライブラリに対する動詞が自然に料理っぽくなりそうな気がして凄い面白くなりそう」の後で考案された用語について検討していなかったので、検討して<a href="conversations/words.txt">掲載</a>する。</p>
<p>出てきていた案がこちら。</p>
<table>
	<thead><tr><td>リパライン語</td><td>直訳</td><td>意味</td></thead>
<tr><td>hynaumares</td><td>毒を盛る；毒が混入する</td><td>エンバグする
</td></tr><tr><td>afnaryl</td><td>除去する道具；解毒剤；消毒</td><td>デバッガー(ソフトウェア)」
</td></tr><tr><td>afnaryler</td><td>消毒する人</td><td>デバッガー(人)
</td></tr><tr><td>arsnus</td><td>嘔吐；吐くこと</td><td>コアダンプ
</td></tr><tr><td>arsnuses</td><td>嘔吐する</td><td>コアダンプを吐く
</td></tr><tr><td>zalizales</td><td>飾る；装飾する</td><td>push
</td></tr><tr><td>ycax</td><td>整理する</td><td>pop
</td></tr><tr><td>artenerfe knloan</td><td>無銭飲食する</td><td>異常な値を出力する《要検討》
</td></tr><tr><td>tvarlon knloan</td><td>盗み食いする</td><td>デバッグ出力用の関数
</td></tr><tr><td></td><td>皿を洗う</td><td>初期化する
</td></tr><tr><td></td><td>汚れた皿</td><td>未初期化の変数
</td></tr><tr><td></td><td>皿</td><td>変数
</td></tr><tr><td></td><td>お箸とかフォーク</td><td>ポインタ</td></tr></table>
<p>「食い逃げ、なんか違うのでは」「食い逃げはどちらかと言うとセキュリティ違反系統では」ぐらいの発言だけをして、それら以外については「採用」とも「不採用」ともせずに放置していたが、</p>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">そういえば、「対話型ソフトウェアの」と「シャーツニアーの」でxarzni&#39;arvenが被ってた(計算機科学 vs リパラオネ宗敎斈)</p>&mdash; Fafs (@sashimiwiki) <a href="https://twitter.com/sashimiwiki/status/922164025105965056?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">確かに。宗教学者が公共交通機関で計算機科学者の会話聞いたら混乱しそう</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/922164246447759361?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr"><a href="https://t.co/WKozT12kkj">https://t.co/WKozT12kkj</a><br><br>お試しに小噺を</p>&mdash; Fafs (@sashimiwiki) <a href="https://twitter.com/sashimiwiki/status/922170094616055809?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">よきかな（ここら辺の用語、採用してないな。採用して飯食いに行くか）</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/922170506970673152?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">採用？</p>&mdash; Fafs (@sashimiwiki) <a href="https://twitter.com/sashimiwiki/status/922170848651313153?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">エンバグ・デバッグ・コアダンプは正式採用するつもり。「汚れた皿」は俗語判定かなぁ（現世の「ゴミが入ってる」ぐらいの頻度では使いそうだけど、企業が脆弱性プレスリリースするときには使わない感じ）</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/922171550328950784?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">なるほどなるほど。</p>&mdash; Fafs (@sashimiwiki) <a href="https://twitter.com/sashimiwiki/status/922172081944502272?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">「hynaumares」ってリパライン語として意図性の強い単語？（偶発的な食中毒事件とかに使える？）</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/922172940715679744?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">意図性は意義に含まれてないので偶発的なのにも使えるよ。</p>&mdash; Fafs (@sashimiwiki) <a href="https://twitter.com/sashimiwiki/status/922173264973008898?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>ということでhynaumares, afnaryl(-er), arsnus(-es)に関しては正式採用。</p>
<p>ycaxについては、既に<a href="conversations/sort.txt">ソート</a>で使っているので避けたいなぁ、という感情</p>
<p>さて、とりあえず<a href="https://sites.google.com/site/panqateel/yougo">用語集</a>に載せますか。と、その前に借用の確認。</p>
<p>はい、arsnus &lt; ars nusnevoだけどarsがユーゴック由来。</p>

<h3>41-2. そういえば</h3>
<p><a href="conversations/axm.txt">-axmがユーゴックからの借用でした</a>。そういうのは辞書に書いておいていただけるとありがたいなぁ。「引っかかるのはakrunftaxm(-es)だな。まあ2003f時代はアセンブリ言語で書いてたわけですし」となった。</p>

<h3>41-3. ladirという語</h3>
<p>理語ladirは理語laに有語由来の接尾辞-dirがついたものと考えられていたが、ladirの初出は実はユーゲ人との接触より早かったということが確認された。というのも、ユエスレオネ主義の革命歌「<a href="https://www63.atwiki.jp/undeerl/pages/354.html">国際共産主義活動よ、連合せよ(理:Ispienermedarneust shrlo da enomionas!)</a>」に登場するのである。<a href="https://gist.github.com/sozysozbot/b42d6e1bd1b7ea3cf6342e21630d623d">議論</a>の結果、「古理lrad（神）が関係しているのではなかろうか」という話になった。</p>
<p>ということで、<a href="https://sites.google.com/site/panqateel/yougo">用語集</a>を改定。</p>

<h2>42. ラテン字転写の罠</h2>
<h3>42-1. rer</h3>
<p>リパーシェで表示して気づいたけど、<a href="tarai.jurli.html">たらい関数</a>、<code>tarai</code>だと/taːaj/だな。<code>ta'Rai</code>にしないと<code>taraj</code>にならない。</p>
<p>待てよ。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">よく考えたらkrzってfaistaderの対象になるな。krzもkRzも許容することにするか <a href="https://twitter.com/hashtag/%E6%82%A0%E9%87%8C%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA?src=hash&amp;ref_src=twsrc%5Etfw">#悠里アセンブリ</a></p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/926568743328653312?ref_src=twsrc%5Etfw">2017年11月3日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">krz, malkrz, droの3つか</p>&mdash; .sozysozbot.@hsjoihs (@sosoBOTpi) <a href="https://twitter.com/sosoBOTpi/status/926569094127558656?ref_src=twsrc%5Etfw">2017年11月3日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>ということで、こいつらをfaistader表記にも対応させた。</p>

<h3>42-2. ついでに</h3>
<p>あ、ついでに、jietoden liparxeだと（lとoだけじゃなく）iとkもめっさ見分けづらいことにも気づいた。</p>

<h2>43. 言語と歴史again</h2>
<p><a href="conversations/multilingual.txt">ユエスレオネの教科書について話していた</a>ところ、「ユエスレオネは民族言語教育にうるさ」く、「多言語教育・多言語行政がわりと取り柄なところがある」とのことで、「多言語の強制的保護はイェスカの思想が強い」とのことなので、「2003f当初から悠里OSに多言語対応入れるモチベが出るのでは？」という説が出た。ただ、「悠里OSの多言語対応はデュインが落ち着いてからが現実的」であるらしく、そういうことなら実際の着手はイェスカ死後なのだろう、となった。「思想的な下地は既にあったが、まともに動き出すのはイェスカ死後にカネが絡みはじめてから」ぐらいの感じで良さそうである。</p>
<p>実際、思想・理想としての多言語の強制的保護が下地にあったとしても、用語やらなんやらを整備するにはカネも時間もかかるわけだし、現実的に始動し出すのは「市場拡大として行われる」ようになってからと考えた方が自然な気がする。</p>


<hr>
<h2>xxx. To do</h2>
<h3>xxx-1. 割り算</h3>
<p>ゼロ割りどうしよう。商を不定値、余りを入力にするとか？あと、負の数がらみをどうするか</p>

<h3>xxx-2. 入門書</h3>
<p>2003'd ferlesylでプログラミングを学ぶっていう資料欲しいよね。えすわい本人もやってみたいって言ってるし、書いてみるか。</p>
<h3>xxx-4. 呼び出し規約</h3>
<p>アセンブリ言語側で32bit呼び出し規約を表現する方法を作りたいよね</p>
<h3>xxx-5. malloc</h3>
<p>malloc欲しい。</p>
<h3>xxx-7. マクロ</h3>
<p>マクロ欲しい。</p>
<h3>xxx-8. エラーメッセージの理語化</h3>
<p>ラッパは被せたので、訳すとかしていかねば</p>
</body>
</html>
